{% extends "base.html" %}

{% block title %}Gestión de Usuarios - Sistema{% endblock %}

{% block page_title %}<i class="fas fa-users me-2"></i>Gestión de Usuarios{% endblock %}

{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}


<div class="container-fluid">

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
  {% endif %}

  <!-- Formulario de usuarios -->
  <div class="form-container">
    
    <form action="{{ url_for('usuarios_routes.usuarios') }}" method="post">
      <div class="form-section">
        <div class="form-group">
          <label for="nombre">Nombre Completo <span class="required">*</span></label>
          <input type="text" id="nombre" name="nombre" class="form-control" 
                 value="{{ usuario_editar['nombre'] if usuario_editar else '' }}" 
                 placeholder="Nombre completo del usuario" required>
        </div>
        
        <div class="form-group">
          <label for="username">Usuario <span class="required">*</span></label>
          <input type="text" id="username" name="username" class="form-control"
                 value="{{ usuario_editar['usuario'] if usuario_editar else '' }}" 
                 placeholder="Nombre de usuario único" required>
        </div>
        
        <div class="form-group">
          <label for="password">Contraseña <span class="required">*</span></label>
          <input type="password" id="password" name="password" class="form-control" 
                 placeholder="{% if usuario_editar %}Dejar vacío para mantener la actual{% else %}Nueva contraseña{% endif %}"
                 {% if not usuario_editar %}required{% endif %}>
        </div>
        
        <div class="form-group">
          <label for="rol">Rol <span class="required">*</span></label>
          <select id="rol" name="rol" class="form-control" required>
            <option value="">-- Selecciona un rol (obligatorio) --</option>
            <option value="administrador" {% if usuario_editar and usuario_editar['rol'] == 'administrador' %}selected{% endif %}>
              Administrador
            </option>
            <option value="operador" {% if usuario_editar and usuario_editar['rol'] == 'operador' %}selected{% endif %}>
              Operador
            </option>
            <option value="supervisor" {% if usuario_editar and usuario_editar['rol'] == 'supervisor' %}selected{% endif %}>
              Supervisor
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="estado">Estado <span class="required">*</span></label>
          <select id="estado" name="estado" class="form-control" required>
            <option value="1" {% if not usuario_editar or usuario_editar['activo'] %}selected{% endif %}>Activo</option>
            <option value="0" {% if usuario_editar and not usuario_editar['activo'] %}selected{% endif %}>Inactivo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="regional">Regional <span class="required">*</span></label>
          <input type="text" id="regional" name="regional" class="form-control" 
                 value="{{ usuario_editar['regional'] if usuario_editar and usuario_editar['regional'] else '' }}" 
                 placeholder="Regional o zona geográfica del usuario" required>
        </div>
      </div>
      
      <div class="text-center">
        {% if usuario_editar %}
          <button type="submit" name="accion" value="editar" class="btn btn-warning btn-sm btn-auto-width">
            <i class="fas fa-save me-2"></i>Actualizar Usuario
          </button>
          <button type="submit" name="accion" value="cancelar" class="btn btn-secondary btn-sm btn-auto-width">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
        {% else %}
          <button type="submit" name="accion" value="agregar" class="btn btn-primary btn-sm btn-add">
            <i class="fas fa-plus me-2"></i>Agregar Usuario
          </button>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Lista de usuarios -->
  <div class="table-users">
    <h3 class="p-3 mb-0 border-bottom">
      <i class="fas fa-list me-2"></i>Usuarios Registrados
    </h3>
    
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for usuario in usuarios %}
          <tr>
            <td>{{ usuario.nombre or 'Sin nombre' }}</td>
            <td>{{ usuario.usuario }}</td>
            <td>
              {% if usuario.rol %}
                <span class="badge badge-{{ usuario.rol|replace(' ', '-') }}">{{ usuario.rol|title }}</span>
              {% else %}
                <span class="badge bg-secondary">Sin rol</span>
              {% endif %}
            </td>
            <td>
              {% if usuario.activo %}
                <span class="status-badge status-active">Activo</span>
              {% else %}
                <span class="status-badge status-inactive">Inactivo</span>
              {% endif %}
            </td>
            <td>
              <form class="form-inline" method="post" action="{{ url_for('usuarios_routes.usuarios') }}">
                <input type="hidden" name="username" value="{{ usuario.usuario }}">
                <button type="submit" name="accion" value="mostrar_editar" class="btn btn-warning btn-sm btn-edit" title="Editar usuario">
                  <i class="fas fa-edit"></i>
                </button>
              </form>
              <form class="form-inline" method="post" action="{{ url_for('usuarios_routes.usuarios') }}" 
                    onsubmit="return confirm('¿Está seguro de eliminar este usuario?')">
                <input type="hidden" name="username" value="{{ usuario.usuario }}">
                <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm btn-edit" title="Eliminar usuario">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[action*="usuarios"]');
    const rolSelect = document.getElementById('rol');
    
    if (form && rolSelect) {
        form.addEventListener('submit', function(e) {
            const accion = e.submitter.value;
            
            // Solo validar para agregar y editar
            if (accion === 'agregar' || accion === 'editar') {
                if (!rolSelect.value || rolSelect.value.trim() === '') {
                    e.preventDefault();
                    alert('Error: Debe seleccionar un rol para el usuario. El rol es obligatorio.');
                    rolSelect.focus();
                    rolSelect.style.borderColor = '#dc2626';
                    return false;
                }
            }
        });
        
        // Remover el borde rojo cuando se selecciona un rol
        rolSelect.addEventListener('change', function() {
            if (this.value) {
                this.style.borderColor = '#e5e7eb';
            }
        });
    }
});
</script>

{% endblock %}