{% extends "base.html" %}

{% block title %}Gestión de Puntos Geográficos - Sistema{% endblock %}

{% block page_title %}<i class="fas fa-map-marker-alt me-2"></i>Gestión de Puntos Geográficos{% endblock %}



{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='puntoGeografico.css') }}">

<div class="container-fluid">

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
  {% endif %}

  <!-- Formulario de puntos geográficos -->
  <div class="punto-container">
    <form method="POST" action="{{ url_for('puntos_geograficos_routes.puntos_geograficos') }}">
      <div class="form-inline">
        <div class="form-group">
          <label for="nombre">Nombre <span class="required">*</span></label>
          <input type="text" id="nombre" name="nombre" class="form-control" required placeholder="Nombre del punto">
        </div>
        
        <div class="form-group">
          <label for="departamento_id">Departamento <span class="required">*</span></label>
          <select id="departamento_id" name="departamento_id" class="form-control" required onchange="cargarMunicipios()">
            <option value="">Seleccionar</option>
            {% for depto in departamentos %}
            <option value="{{ depto.id }}">{{ depto.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="municipio_id">Municipio <span class="required">*</span></label>
          <select id="municipio_id" name="municipio_id" class="form-control" required>
            <option value="">Seleccionar</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="direccion">Dirección</label>
          <input type="text" id="direccion" name="direccion" class="form-control" placeholder="Dirección del punto">
        </div>
      </div>
      
      <div class="form-inline">
        <div class="form-group">
          <label for="latitud">Latitud <span class="required">*</span></label>
          <input type="number" step="any" id="latitud" name="latitud" class="form-control" required placeholder="14.123456">
        </div>
        
        <div class="form-group">
          <label for="longitud">Longitud <span class="required">*</span></label>
          <input type="number" step="any" id="longitud" name="longitud" class="form-control" required placeholder="-89.123456">
        </div>
        
        <div class="form-group">
          <label for="descripcion">Descripción</label>
          <textarea id="descripcion" name="descripcion" class="form-control" rows="2" placeholder="Descripción del punto geográfico" style="height: auto; min-height: 60px;"></textarea>
        </div>
      </div>
      
      <div class="text-center">
        <button type="submit" name="accion" value="agregar" class="btn btn-primary" style="width: auto; display: inline-block; padding: 0.5rem 1.5rem;">
          <i class="fas fa-plus me-2"></i>Agregar Punto
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de puntos geográficos -->
  <div class="table-container">
    <h3 class="p-3 mb-0 border-bottom">
      <i class="fas fa-list me-2"></i>Puntos Geográficos Registrados
    </h3>
    
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Departamento</th>
            <th>Municipio</th>
            <th>Coordenadas</th>
            <th>Dirección</th>
            <th>Fecha Registro</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for punto in puntos_geograficos %}
          <tr>
            <td>{{ punto.id }}</td>
            <td>{{ punto.nombre }}</td>
            <td>{{ punto.departamento_nombre or 'N/A' }}</td>
            <td>{{ punto.municipio_nombre or 'N/A' }}</td>
            <td class="coordinates">
              {% if punto.latitud and punto.longitud %}
                {{ "%.6f"|format(punto.latitud) }},<br>{{ "%.6f"|format(punto.longitud) }}
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ punto.direccion or 'N/A' }}</td>
            <td>{{ punto.fecha_registro.strftime('%Y-%m-%d %H:%M') if punto.fecha_registro else 'N/A' }}</td>
            <td style="text-align: center;">
              <div class="btn-group" role="group">
                <button class="btn btn-warning btn-sm" onclick="editarPunto('{{ punto.id }}')" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;" title="Editar punto geográfico">
                  <i class="fas fa-edit"></i>
                </button>
                <form style="display: inline;" method="POST" action="{{ url_for('puntos_geograficos_routes.puntos_geograficos') }}" 
                      onsubmit="return confirm('¿Está seguro de eliminar este punto geográfico?')">
                  <input type="hidden" name="id" value="{{ punto.id }}">
                  <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if not puntos_geograficos %}
    <div class="text-center p-4">
      <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
      <p class="text-muted">No hay puntos geográficos registrados.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal para editar punto geográfico -->
<div id="editModal" class="edit-modal-overlay">
  <div class="edit-modal-content">
    <h3>Editar Punto Geográfico</h3>
    <form id="editForm" method="POST" action="{{ url_for('puntos_geograficos_routes.puntos_geograficos') }}">
      <input type="hidden" name="accion" value="editar">
      <input type="hidden" id="edit_punto_id" name="id">
      
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label>Nombre <span class="required">*</span></label>
            <input type="text" class="form-control" name="nombre" id="edit_nombre" required>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="form-group">
            <label>Dirección</label>
            <input type="text" class="form-control" name="direccion" id="edit_direccion" placeholder="Dirección del punto">
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="form-group">
            <label>Departamento <span class="required">*</span></label>
            <select class="form-control" name="departamento_id" id="edit_departamento_id" required onchange="cargarMunicipiosEditar()">
              <option value="">Seleccionar</option>
              {% for depto in departamentos %}
              <option value="{{ depto.id }}">{{ depto.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="form-group">
            <label>Municipio <span class="required">*</span></label>
            <select class="form-control" name="municipio_id" id="edit_municipio_id" required>
              <option value="">Seleccionar municipio</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="form-group">
            <label>Latitud <span class="required">*</span></label>
            <input type="number" class="form-control" name="latitud" id="edit_latitud" step="any" required>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="form-group">
            <label>Longitud <span class="required">*</span></label>
            <input type="number" class="form-control" name="longitud" id="edit_longitud" step="any" required>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-12">
          <div class="form-group">
            <label>Descripción</label>
            <textarea class="form-control" name="descripcion" id="edit_descripcion" rows="3" placeholder="Descripción del punto geográfico"></textarea>
          </div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button type="button" onclick="cerrarModal()" class="btn btn-secondary modal-btn">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="submit" class="btn btn-primary modal-btn">
          <i class="fas fa-save me-1"></i>Actualizar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Cargar municipios según departamento seleccionado
function cargarMunicipios() {
    const departamentoId = document.getElementById('departamento_id').value;
    const municipioSelect = document.getElementById('municipio_id');
    
    // Limpiar municipios
    municipioSelect.innerHTML = '<option value="">Seleccionar</option>';
    
    if (departamentoId) {
        fetch(`/api/municipios/${departamentoId}`)
            .then(response => response.json())
            .then(municipios => {
                municipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.textContent = municipio.nombre;
                    municipioSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar municipios:', error);
            });
    }
}

// Editar punto geográfico
function editarPunto(puntoId) {
    // Buscar los datos del punto en la tabla
    const tabla = document.querySelector('table tbody');
    const filas = tabla.querySelectorAll('tr');
    
    for (let fila of filas) {
        const celdas = fila.querySelectorAll('td');
        const idPunto = celdas[0].textContent.trim();
        
        if (idPunto === puntoId) {
            // Extraer datos de la fila (índices correctos según la tabla)
            const nombre = celdas[1].textContent.trim();
            const departamento = celdas[2].textContent.trim();
            const municipio = celdas[3].textContent.trim();
            const coordenadas = celdas[4].textContent.trim();
            const direccion = celdas[5].textContent.trim();
            
            console.log('Datos extraídos:', {
                id: puntoId,
                nombre: nombre,
                departamento: departamento,
                municipio: municipio,
                coordenadas: coordenadas,
                direccion: direccion
            });
            
            // Extraer latitud y longitud de las coordenadas
            const coordsMatch = coordenadas.match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
            const latitud = coordsMatch ? coordsMatch[1] : '';
            const longitud = coordsMatch ? coordsMatch[2] : '';
            
            // Llenar los campos básicos del modal
            document.getElementById('edit_punto_id').value = puntoId;
            document.getElementById('edit_nombre').value = nombre;
            document.getElementById('edit_direccion').value = direccion === 'N/A' ? '' : direccion;
            document.getElementById('edit_latitud').value = latitud;
            document.getElementById('edit_longitud').value = longitud;
            
            // Buscar y seleccionar el departamento
            const selectDepartamento = document.getElementById('edit_departamento_id');
            let departamentoEncontrado = false;
            
            for (let option of selectDepartamento.options) {
                if (option.textContent.trim() === departamento && departamento !== 'N/A') {
                    option.selected = true;
                    departamentoEncontrado = true;
                    console.log('Departamento seleccionado:', departamento);
                    break;
                }
            }
            
            // Si se encontró el departamento, cargar municipios y seleccionar el correcto
            if (departamentoEncontrado) {
                // Cargar municipios de forma asíncrona y luego seleccionar
                cargarMunicipiosEditar().then(() => {
                    const selectMunicipio = document.getElementById('edit_municipio_id');
                    for (let option of selectMunicipio.options) {
                        if (option.textContent.trim() === municipio && municipio !== 'N/A') {
                            option.selected = true;
                            console.log('Municipio seleccionado:', municipio);
                            break;
                        }
                    }
                });
            }
            
            // Mostrar el modal
            document.getElementById('editModal').style.display = 'block';
            break;
        }
    }
}

// Cargar municipios para el modal de edición
function cargarMunicipiosEditar() {
    return new Promise((resolve) => {
        const departamentoId = document.getElementById('edit_departamento_id').value;
        const municipioSelect = document.getElementById('edit_municipio_id');
        
        console.log('Cargando municipios para departamento ID:', departamentoId);
        
        municipioSelect.innerHTML = '<option value="">Seleccionar municipio</option>';
        
        if (departamentoId) {
            fetch(`/api/municipios/${departamentoId}`)
                .then(response => response.json())
                .then(municipios => {
                    console.log('Municipios cargados:', municipios);
                    municipios.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.id;
                        option.textContent = municipio.nombre;
                        municipioSelect.appendChild(option);
                    });
                    resolve();
                })
                .catch(error => {
                    console.error('Error cargando municipios:', error);
                    resolve();
                });
        } else {
            resolve();
        }
    });
}

// Cerrar modal de edición
function cerrarModal() {
    document.getElementById('editModal').style.display = 'none';
}

// Obtener ubicación actual del usuario
function obtenerUbicacionActual() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('latitud').value = position.coords.latitude.toFixed(6);
            document.getElementById('longitud').value = position.coords.longitude.toFixed(6);
        }, function(error) {
            alert('No se pudo obtener la ubicación: ' + error.message);
        });
    } else {
        alert('La geolocalización no es compatible con este navegador');
    }
}

// Agregar botón para obtener ubicación actual
document.addEventListener('DOMContentLoaded', function() {
    const longitudInput = document.getElementById('longitud');
    if (longitudInput) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-secondary btn-sm';
        button.innerHTML = '<i class="fas fa-crosshairs"></i> Mi ubicación';
        button.onclick = obtenerUbicacionActual;
        button.style.marginLeft = '0.5rem';
        button.style.height = '32px';
        longitudInput.parentNode.appendChild(button);
    }
    
    // Cerrar modal al hacer clic fuera de él
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cerrarModal();
            }
        });
    }
});
</script>
{% endblock %}