{% extends "base.html" %}

{% block title %}Gestión de Puntos Geográficos - Sistema{% endblock %}

{% block page_title %}Gestión de Puntos Geográficos{% endblock %}

{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}
<style>
.punto-container {
  background: #fff;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  margin-bottom: 2rem;
}

/* Estilo del formulario igual al de usuarios */
.form-inline {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  align-items: start;
}

.form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 0;
}

.form-group label {
  margin-bottom: 0.5rem;
  font-weight: 500;
  font-size: 1rem;
  color: #495057;
}

.form-group .form-control {
  padding: 0.75rem;
  border: 2px solid #e9ecef;
  border-radius: 0.375rem;
  font-size: 1rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  width: 100%;
}

.form-group .form-control:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-primary {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
  border-radius: 0.375rem;
  font-weight: 500;
  transition: all 0.15s ease-in-out;
}

.btn-primary:hover {
  background-color: #0056b3;
  border-color: #0056b3;
  transform: translateY(-1px);
}

.btn-secondary {
  background: #6b7280;
  border: none;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-warning {
  background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
  border: none;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-danger {
  background: linear-gradient(90deg, #dc2626 0%, #b91c1c 100%);
  border: none;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.btn:hover {
  transform: translateY(-1px);
}

.table-container {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.table {
  margin-bottom: 0;
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: #374151;
  border: none;
  padding: 1rem;
}

.table td {
  padding: 1rem;
  border-color: #f1f5f9;
  vertical-align: middle;
}

.required {
  color: #dc2626;
}

.coordinates {
  font-family: monospace;
  font-size: 0.8rem;
  color: #6b7280;
}
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">
        <i class="fas fa-map-marker-alt me-2"></i>Gestión de Puntos Geográficos
      </h1>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
  {% endif %}

  <!-- Formulario de puntos geográficos -->
  <div class="punto-container">
    <h3 class="mb-3">Agregar Nuevo Punto Geográfico</h3>
    
    <form method="POST" action="{{ url_for('puntos_geograficos') }}">
      <div class="form-inline">
        <div class="form-group">
          <label for="nombre">Nombre <span class="required">*</span></label>
          <input type="text" id="nombre" name="nombre" class="form-control" required placeholder="Nombre del punto">
        </div>
        
        <div class="form-group">
          <label for="departamento_id">Departamento <span class="required">*</span></label>
          <select id="departamento_id" name="departamento_id" class="form-control" required onchange="cargarMunicipios()">
            <option value="">Seleccionar</option>
            {% for depto in departamentos %}
            <option value="{{ depto.id }}">{{ depto.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="municipio_id">Municipio <span class="required">*</span></label>
          <select id="municipio_id" name="municipio_id" class="form-control" required>
            <option value="">Seleccionar</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="direccion">Dirección</label>
          <input type="text" id="direccion" name="direccion" class="form-control" placeholder="Dirección del punto">
        </div>
      </div>
      
      <div class="form-inline">
        <div class="form-group">
          <label for="latitud">Latitud <span class="required">*</span></label>
          <input type="number" step="any" id="latitud" name="latitud" class="form-control" required placeholder="14.123456">
        </div>
        
        <div class="form-group">
          <label for="longitud">Longitud <span class="required">*</span></label>
          <input type="number" step="any" id="longitud" name="longitud" class="form-control" required placeholder="-89.123456">
        </div>
        
        <div class="form-group">
          <label for="descripcion">Descripción</label>
          <textarea id="descripcion" name="descripcion" class="form-control" rows="2" placeholder="Descripción del punto geográfico" style="height: auto; min-height: 60px;"></textarea>
        </div>
      </div>
      
      <div class="text-center">
        <button type="submit" name="accion" value="agregar" class="btn btn-primary" style="width: auto; display: inline-block; padding: 0.5rem 1.5rem;">
          <i class="fas fa-plus me-2"></i>Agregar Punto
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de puntos geográficos -->
  <div class="table-container">
    <h3 class="p-3 mb-0 border-bottom">
      <i class="fas fa-list me-2"></i>Puntos Geográficos Registrados
    </h3>
    
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Departamento</th>
            <th>Municipio</th>
            <th>Coordenadas</th>
            <th>Dirección</th>
            <th>Fecha Registro</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for punto in puntos_geograficos %}
          <tr>
            <td>{{ punto.id }}</td>
            <td>{{ punto.nombre }}</td>
            <td>{{ punto.departamento_nombre or 'N/A' }}</td>
            <td>{{ punto.municipio_nombre or 'N/A' }}</td>
            <td class="coordinates">
              {% if punto.latitud and punto.longitud %}
                {{ "%.6f"|format(punto.latitud) }},<br>{{ "%.6f"|format(punto.longitud) }}
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ punto.direccion or 'N/A' }}</td>
            <td>{{ punto.fecha_registro.strftime('%Y-%m-%d %H:%M') if punto.fecha_registro else 'N/A' }}</td>
            <td style="text-align: center;">
              <div class="btn-group" role="group">
                <button class="btn btn-warning btn-sm" onclick="editarPunto('{{ punto.id }}')" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                  <i class="fas fa-edit"></i>
                </button>
                <form style="display: inline;" method="POST" action="{{ url_for('puntos_geograficos') }}" 
                      onsubmit="return confirm('¿Está seguro de eliminar este punto geográfico?')">
                  <input type="hidden" name="id" value="{{ punto.id }}">
                  <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if not puntos_geograficos %}
    <div class="text-center p-4">
      <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
      <p class="text-muted">No hay puntos geográficos registrados.</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
// Cargar municipios según departamento seleccionado
function cargarMunicipios() {
    const departamentoId = document.getElementById('departamento_id').value;
    const municipioSelect = document.getElementById('municipio_id');
    
    // Limpiar municipios
    municipioSelect.innerHTML = '<option value="">Seleccionar</option>';
    
    if (departamentoId) {
        fetch(`/api/municipios/${departamentoId}`)
            .then(response => response.json())
            .then(municipios => {
                municipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.textContent = municipio.nombre;
                    municipioSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar municipios:', error);
            });
    }
}

// Editar punto geográfico
function editarPunto(puntoId) {
    // Implementar lógica de edición
    alert('Función de edición en desarrollo para punto ID: ' + puntoId);
}

// Obtener ubicación actual del usuario
function obtenerUbicacionActual() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('latitud').value = position.coords.latitude.toFixed(6);
            document.getElementById('longitud').value = position.coords.longitude.toFixed(6);
        }, function(error) {
            alert('No se pudo obtener la ubicación: ' + error.message);
        });
    } else {
        alert('La geolocalización no es compatible con este navegador');
    }
}

// Agregar botón para obtener ubicación actual
document.addEventListener('DOMContentLoaded', function() {
    const longitudInput = document.getElementById('longitud');
    if (longitudInput) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-secondary btn-sm';
        button.innerHTML = '<i class="fas fa-crosshairs"></i> Mi ubicación';
        button.onclick = obtenerUbicacionActual;
        button.style.marginLeft = '0.5rem';
        button.style.height = '32px';
        longitudInput.parentNode.appendChild(button);
    }
});
</script>
{% endblock %}