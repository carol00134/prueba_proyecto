{% extends "base.html" %}

{% block title %}Gestión de Cámaras - Sistema{% endblock %}

{% block page_title %}<i class="fas fa-video me-2"></i>Gestión de Cámaras{% endblock %}

{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='camaras.css') }}">

<div class="container-fluid">
  {% if success %}
    <div class="alert alert-success">
      <i class="fas fa-check-circle me-2"></i>{{ success }}
    </div>
  {% endif %}

  {% if error %}
    <div class="alert alert-error">
      <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
    </div>
  {% endif %}

  <!-- Formulario para agregar nueva cámara - Solo si puede crear -->
  {% if can_perform_action('camaras', 'crear') %}
  <div class="camera-container">
    
    <form method="POST" action="{{ url_for('camaras_routes.camaras') }}">
      <input type="hidden" name="accion" value="agregar">
      
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label for="id_camaras">ID Cámara <span class="required">*</span></label>
            <input type="text" class="form-control" name="id_camaras" id="id_camaras" 
                   required placeholder="Ej: CAM001, CAM-2024-001">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="correo">Correo Electrónico <span class="required">*</span></label>
            <input type="email" class="form-control" name="correo" id="correo" 
                   required placeholder="usuario@ejemplo.com">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="nombre">Nombre <span class="required">*</span></label>
            <input type="text" class="form-control" name="nombre" id="nombre" 
                   required placeholder="Nombre completo">
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-4">
          <div class="form-group">
            <label for="estado">Estado <span class="required">*</span></label>
            <select class="form-control" name="estado" id="estado" required>
              <option value="1">Activo</option>
              <option value="0">Inactivo</option>
            </select>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="regional">Regional</label>
            <input type="text" class="form-control" name="regional" id="regional" 
                   placeholder="Ej: Regional Norte, Regional Sur">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="usuario_id">Usuario del Sistema</label>
            <select class="form-control" name="usuario_id" id="usuario_id">
              <option value="">Seleccionar usuario del sistema</option>
              {% if usuarios %}
                {% for usuario in usuarios %}
                <option value="{{ usuario.id }}" 
                        {% if usuario_actual and usuario.id == usuario_actual.id %}selected{% endif %}>
                  {{ usuario.nombre }}{% if usuario.usuario %} ({{ usuario.usuario }}){% endif %}
                  {% if usuario_actual and usuario.id == usuario_actual.id %} - Logueado{% endif %}
                </option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="latitud">Latitud</label>
            <input type="number" class="form-control" name="latitud" id="latitud" 
                   step="0.000001" min="-90" max="90"
                   placeholder="Ej: 14.0723 (Entre -90 y 90)">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="longitud">Longitud</label>
            <input type="number" class="form-control" name="longitud" id="longitud" 
                   step="0.000001" min="-180" max="180"
                   placeholder="Ej: -87.1921 (Entre -180 y 180)">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label for="fecha_creacion">Fecha de Creación</label>
            <input type="date" class="form-control" name="fecha_creacion" id="fecha_creacion">
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12 text-end">
          <button type="submit" class="btn btn-primary" style="width: 180px;">
            <i class="fas fa-plus me-2"></i>Agregar Cámara
          </button>
        </div>
      </div>
    </form>
  </div>
  {% endif %}

  <!-- Lista de cámaras -->
  <div class="table-container">
    <div class="d-flex justify-content-between align-items-center p-4 mb-0 border-bottom">
      <h4 class="mb-0">
        <i class="fas fa-list me-2"></i>Cámaras Registradas
      </h4>
      <div class="d-flex gap-2">
        <a href="{{ url_for('camaras_routes.exportar_camaras_excel') }}" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-file-export me-1"></i>Exportar a Excel
        </a>
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalImportarExcel">
          <i class="fas fa-file-excel me-1"></i>Importar Datos (Excel)
        </button>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID Cámara</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Usuario del Sistema</th>
            <th>Coordenadas</th>
            <th>Estado</th>
            <th>Regional</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if camaras %}
            {% for camara in camaras %}
            <tr>
              <td><strong>{{ camara.id_camaras }}</strong></td>
              <td>{{ camara.nombre }}</td>
              <td>{{ camara.correo }}</td>
              <td>
                {% if camara.usuario_nombre %}
                  <span class="badge bg-info">{{ camara.usuario_nombre }}</span>
                {% else %}
                  <span class="text-muted">Sin asignar</span>
                {% endif %}
              </td>
              <td>
                {% if camara.latitud and camara.longitud %}
                  <small class="text-success">
                    <i class="fas fa-map-pin me-1"></i>
                    {{ "%.6f"|format(camara.latitud) }}, {{ "%.6f"|format(camara.longitud) }}
                  </small>
                {% else %}
                  <span class="text-muted">
                    <i class="fas fa-map-pin me-1"></i>Sin coordenadas
                  </span>
                {% endif %}
              </td>
              <td>
                {% if camara.estado %}
                  <span class="status-badge status-active">Activo</span>
                {% else %}
                  <span class="status-badge status-inactive">Inactivo</span>
                {% endif %}
              </td>
              <td>{{ camara.regional or 'N/A' }}</td>
              <td>
                {% if can_perform_action('camaras', 'editar') %}
                <button class="btn btn-warning btn-sm me-1" 
                        onclick="editarCamara('{{ camara.id_camaras }}')" 
                        title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                {% endif %}
                {% if can_perform_action('camaras', 'eliminar') %}
                <form style="display: inline;" method="POST" action="{{ url_for('camaras_routes.camaras') }}" 
                      onsubmit="return confirm('¿Está seguro de eliminar esta cámara?')">
                  <input type="hidden" name="accion" value="eliminar">
                  <input type="hidden" name="id_camaras" value="{{ camara.id_camaras }}">
                  <button type="submit" class="btn btn-danger btn-sm" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center py-4">
                <i class="fas fa-video fa-3x text-muted mb-3"></i>
                <p class="text-muted">No hay cámaras registradas</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para editar cámara -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="position:relative; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px; max-width:800px; width:90%; max-height:80vh; overflow-y:auto;">
    <h3>Editar Cámara</h3>
    <form id="editForm">
      <input type="hidden" name="accion" value="editar">
      <input type="hidden" name="id_camaras_original" id="edit_id_camaras_original">
      
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label>ID Cámara <span class="required">*</span></label>
            <input type="text" class="form-control" name="id_camaras" id="edit_id_camaras" required readonly style="background-color: #f5f5f5;">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label>Correo Electrónico <span class="required">*</span></label>
            <input type="email" class="form-control" name="correo" id="edit_correo" required>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label>Nombre <span class="required">*</span></label>
            <input type="text" class="form-control" name="nombre" id="edit_nombre" required>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-4">
          <div class="form-group">
            <label>Estado <span class="required">*</span></label>
            <select class="form-control" name="estado" id="edit_estado" required>
              <option value="1">Activo</option>
              <option value="0">Inactivo</option>
            </select>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label>Regional</label>
            <input type="text" class="form-control" name="regional" id="edit_regional">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label>Usuario del Sistema</label>
            <select class="form-control" name="usuario_id" id="edit_usuario_id">
              <option value="">Seleccionar usuario del sistema</option>
              {% if usuarios %}
                {% for usuario in usuarios %}
                <option value="{{ usuario.id }}" 
                        {% if usuario_actual and usuario.id == usuario_actual.id %}selected{% endif %}>
                  {{ usuario.nombre }}{% if usuario.usuario %} ({{ usuario.usuario }}){% endif %}
                  {% if usuario_actual and usuario.id == usuario_actual.id %}{% endif %}
                </option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-4">
          <div class="form-group">
            <label>Latitud</label>
            <input type="number" class="form-control" name="latitud" id="edit_latitud" 
                   step="0.000001" min="-90" max="90"
                   placeholder="Ej: 14.0723 (Entre -90 y 90)">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label>Longitud</label>
            <input type="number" class="form-control" name="longitud" id="edit_longitud" 
                   step="0.000001" min="-180" max="180"
                   placeholder="Ej: -87.1921 (Entre -180 y 180)">
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="form-group">
            <label>Fecha de Creación</label>
            <input type="date" class="form-control" name="fecha_creacion" id="edit_fecha_creacion">
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-12 text-center">
          <button type="button" onclick="cerrarModal()" class="btn btn-secondary btn-sm" style="padding: 4px 8px; font-size: 0.75rem; width: auto; margin-right: 8px;">
            <i class="fas fa-times me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-primary btn-sm" style="padding: 4px 8px; font-size: 0.75rem; width: auto;">
            <i class="fas fa-save me-1"></i>Actualizar
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
function editarCamara(id) {
  console.log('🔧 Iniciando edición de cámara con ID:', id);
  // Obtener datos de la cámara
  fetch('/api/camara/' + id)
    .then(response => {
      console.log('📡 Respuesta del servidor:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('📊 Datos recibidos:', data);
      if (data.success) {
        // Llenar el formulario con los datos
        document.getElementById('edit_id_camaras_original').value = data.camara.id_camaras || '';
        document.getElementById('edit_id_camaras').value = data.camara.id_camaras || '';
        document.getElementById('edit_correo').value = data.camara.correo || '';
        document.getElementById('edit_nombre').value = data.camara.nombre || '';
        document.getElementById('edit_estado').value = data.camara.estado || '1';
        document.getElementById('edit_regional').value = data.camara.regional || '';
        document.getElementById('edit_usuario_id').value = data.camara.usuario_id || '';
        document.getElementById('edit_latitud').value = data.camara.latitud || '';
        document.getElementById('edit_longitud').value = data.camara.longitud || '';
        
        // Manejar fecha de creación
        if (data.camara.fecha_creacion) {
          // Si la fecha viene como string, la usamos directamente
          if (typeof data.camara.fecha_creacion === 'string') {
            document.getElementById('edit_fecha_creacion').value = data.camara.fecha_creacion.split(' ')[0]; // Solo la fecha, sin la hora
          } else {
            document.getElementById('edit_fecha_creacion').value = data.camara.fecha_creacion;
          }
        } else {
          document.getElementById('edit_fecha_creacion').value = '';
        }
        
        // Mostrar el modal
        document.getElementById('editModal').style.display = 'block';
        console.log('✅ Modal de edición mostrado');
      } else {
        console.error('❌ Error en respuesta:', data.message);
        alert('Error al obtener los datos de la cámara: ' + (data.message || 'Error desconocido'));
      }
    })
    .catch(error => {
      console.error('❌ Error en fetch:', error);
      alert('Error al obtener los datos de la cámara');
    });
}

function cerrarModal() {
  document.getElementById('editModal').style.display = 'none';
}

// Manejar el envío del formulario de edición
document.getElementById('editForm').addEventListener('submit', function(e) {
  e.preventDefault();
  console.log('📝 Enviando formulario de edición...');
  
  const formData = new FormData(this);
  console.log('📋 Datos del formulario:');
  for (let [key, value] of formData.entries()) {
    console.log(`   ${key}: ${value}`);
  }
  
  fetch('/camaras', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    console.log('📡 Respuesta del servidor (edición):', response.status);
    return response.json();
  })
  .then(data => {
    console.log('📊 Respuesta de edición:', data);
    if (data.success) {
      alert('Cámara actualizada correctamente');
      location.reload(); // Recargar la página para ver los cambios
    } else {
      alert('Error al actualizar la cámara: ' + (data.message || 'Error desconocido'));
    }
  })
  .catch(error => {
    console.error('❌ Error en envío:', error);
    alert('Error al actualizar la cámara');
  });
});

// Cerrar modal al hacer clic fuera de él
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) {
    cerrarModal();
  }
});
</script>

<!-- Modal para importar Excel -->
<div class="modal fade" id="modalImportarExcel" tabindex="-1" aria-labelledby="modalImportarExcelLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalImportarExcelLabel">
          <i class="fas fa-file-excel me-2"></i>Importar Cámaras desde Excel
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
             
              
              <form id="formImportarExcel" enctype="multipart/form-data">
                <div class="mb-3">
                  <label for="archivoExcel" class="form-label fw-bold">
                    <i class="fas fa-upload me-1"></i>Seleccionar archivo Excel
                  </label>
                  <input type="file" 
                         class="form-control form-control-lg" 
                         id="archivoExcel" 
                         name="archivo_excel" 
                         accept=".xlsx,.xls" 
                         required>
                  <div class="form-text">
                    <i class="fas fa-file-excel me-1 text-success"></i>
                    Solo archivos Excel (.xlsx, .xls)
                  </div>
                </div>
                
                <div id="resultadoImportacion" class="alert" style="display: none;"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-success" id="btnImportar">
          <i class="fas fa-upload me-1"></i>Importar Datos
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Funcionalidad para importar Excel
document.getElementById('btnImportar').addEventListener('click', function() {
  const form = document.getElementById('formImportarExcel');
  const archivo = document.getElementById('archivoExcel').files[0];
  const resultado = document.getElementById('resultadoImportacion');
  const btnImportar = document.getElementById('btnImportar');
  
  if (!archivo) {
    resultado.className = 'alert alert-danger';
    resultado.style.display = 'block';
    resultado.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Por favor seleccione un archivo Excel.';
    return;
  }
  
  // Mostrar estado de carga
  btnImportar.disabled = true;
  btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Importando...';
  resultado.style.display = 'none';
  
  // Crear FormData para enviar el archivo
  const formData = new FormData();
  formData.append('archivo_excel', archivo);
  
  // Enviar archivo al servidor
  fetch('{{ url_for("camaras_routes.importar_camaras_excel") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    btnImportar.disabled = false;
    btnImportar.innerHTML = '<i class="fas fa-upload me-1"></i>Importar Datos';
    
    if (data.success) {
      resultado.className = 'alert alert-success';
      resultado.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>Importación exitosa!</strong><br>
        ${data.message}
        ${data.detalles ? `
          <div class="mt-2">
            <small>
              • Registros creados: ${data.detalles.registros_exitosos}<br>
              • Registros actualizados: ${data.detalles.registros_actualizados}<br>
              • Total procesados: ${data.detalles.total_procesados}
            </small>
          </div>
        ` : ''}
      `;
      
      // Recargar la página después de 3 segundos
      setTimeout(() => {
        location.reload();
      }, 3000);
    } else {
      resultado.className = 'alert alert-danger';
      resultado.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Error en la importación:</strong><br>
        ${data.message}
        ${data.detalles && data.detalles.errores && data.detalles.errores.length > 0 ? `
          <div class="mt-2">
            <small><strong>Primeros errores encontrados:</strong></small>
            <ul class="mb-0">
              ${data.detalles.errores.slice(0, 5).map(error => `<li><small>${error}</small></li>`).join('')}
            </ul>
          </div>
        ` : ''}
      `;
    }
    
    resultado.style.display = 'block';
  })
  .catch(error => {
    console.error('Error:', error);
    btnImportar.disabled = false;
    btnImportar.innerHTML = '<i class="fas fa-upload me-1"></i>Importar Datos';
    
    resultado.className = 'alert alert-danger';
    resultado.style.display = 'block';
    resultado.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Error de conexión. Inténtelo nuevamente.';
  });
});

// Limpiar formulario cuando se cierra el modal
document.getElementById('modalImportarExcel').addEventListener('hidden.bs.modal', function() {
  document.getElementById('formImportarExcel').reset();
  document.getElementById('resultadoImportacion').style.display = 'none';
  const btnImportar = document.getElementById('btnImportar');
  btnImportar.disabled = false;
  btnImportar.innerHTML = '<i class="fas fa-upload me-1"></i>Importar Datos';
});
</script>

{% endblock %}