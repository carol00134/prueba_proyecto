{% extends "base.html" %}

{% block title %}Lista de Tickets - Sistema{% endblock %}

{% block page_title %}Gestión de Tickets{% endblock %}

{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}
<style>
.ticket-container {
  background: #fff;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  margin-bottom: 2rem;
}

.form-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
}

.form-control, .form-select {
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 0.5rem;
  font-size: 0.875rem;
}

.btn {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  line-height: 1.5;
}

.btn-group .btn {
  margin: 0;
}

.btn-outline-warning {
  color: #f59e0b;
  border: 1px solid #f59e0b;
  background: white;
}

.btn-outline-warning:hover {
  background: #f59e0b;
  color: white;
}

.btn-outline-danger {
  color: #dc2626;
  border: 1px solid #dc2626;
  background: white;
}

.btn-outline-danger:hover {
  background: #dc2626;
  color: white;
}

.btn-primary { background: #3b82f6; color: white; }
.btn-secondary { background: #6b7280; color: white; }
.btn-warning { background: #f59e0b; color: white; }
.btn-danger { background: #dc2626; color: white; }
.btn-success { background: #10b981; color: white; }

.ticket-id-link {
  color: #6366f1 !important;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
}

.ticket-id-link:hover {
  color: #4338ca !important;
  text-decoration: underline;
}

.table th:last-child,
.table td:last-child {
  width: 120px;
  text-align: center;
}

.table-container {
  overflow-x: auto;
}

.table {
  font-size: 0.875rem;
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: #374151;
  border: none;
  padding: 1rem;
  font-size: 0.875rem;
}

.table td {
  padding: 0.75rem;
  border-color: #f1f5f9;
  vertical-align: middle;
  font-size: 0.875rem;
}

.coordinates {
  font-family: monospace;
  font-size: 0.8rem;
}

.edit-row {
  background: #f0f9ff !important;
  border-left: 4px solid #3b82f6;
}

.page-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e5e7eb;
}
</style>

<div class="container-fluid px-4">
  <div class="page-header">
    <h2><i class="fas fa-ticket-alt me-2"></i>Gestión de Tickets</h2>
    <p class="text-muted mb-0">Administre y visualice todos los tickets del sistema</p>
  </div>

  <!-- Mostrar errores -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Lista de tickets -->
  <div class="ticket-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Lista de Tickets</h5>
      <a href="/agregar_ticket" class="btn btn-primary btn-sm" style="width: auto; display: inline-block; padding: 0.5rem 1.5rem;">
        <i class="fas fa-plus me-1"></i>Agregar Ticket
      </a>
    </div>
    
    <!-- Filtros -->
    <div class="row mb-3">
      <div class="col-md-3">
        <select class="form-select" id="filtro_departamento" onchange="cargarMunicipiosFiltro(); filtrarTickets();">
          <option value="">Todos los departamentos</option>
          {% for depto in departamentos %}
          <option value="{{ depto.id }}">{{ depto.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="filtro_municipio" onchange="filtrarTickets()" disabled>
          <option value="">Todos los municipios</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" id="filtro_tipologia" onchange="filtrarTickets()">
          <option value="">Todas las tipologías</option>
          {% for tipo in tipologias %}
          <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" id="filtro_fecha" onchange="filtrarTickets()">
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary btn-sm" onclick="limpiarFiltros()" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
          <i class="fas fa-refresh"></i> Limpiar
        </button>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-responsive">
        <table class="table" id="ticketsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Departamento</th>
              <th>Municipio</th>
              <th>Tipología</th>
              <th>Coordenadas</th>
              <th>Usuario</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
            <tr id="ticket-row-{{ ticket.id }}">
              <td>
                <a href="/ticket/{{ ticket.id }}" class="ticket-id-link">
                  {{ ticket.id }}
                </a>
              </td>
              <td>{{ ticket.fecha_hora.strftime('%Y-%m-%d') if ticket.fecha_hora else 'N/A' }}</td>
              <td data-departamento-id="{{ ticket.departamento_id or '' }}">{{ ticket.departamento_nombre or 'N/A' }}</td>
              <td data-municipio-id="{{ ticket.municipio_id or '' }}">{{ ticket.municipio_nombre or 'N/A' }}</td>
              <td data-tipologia-id="{{ ticket.tipologia_id or '' }}">{{ ticket.tipologia_nombre or 'N/A' }}</td>
              <td class="coordinates">
                {% if ticket.latitud and ticket.longitud %}
                  {{ "%.6f"|format(ticket.latitud) }},<br>{{ "%.6f"|format(ticket.longitud) }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>{{ ticket.usuario_nombre or 'N/A' }}</td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-warning btn-sm" onclick="editarTicket('{{ ticket.id }}')" title="Editar" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="eliminarTicket('{{ ticket.id }}')" title="Eliminar" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {% if not tickets %}
      <div class="text-center p-4">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">No hay tickets registrados.</p>
        <a href="/agregar_ticket" class="btn btn-primary btn-sm" style="width: auto; display: inline-block; padding: 0.5rem 1.5rem;">
          <i class="fas fa-plus me-1"></i>Crear el primer ticket
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Editar ticket (redirigir a página de edición)
function editarTicket(ticketId) {
    window.location.href = '/editar_ticket/' + ticketId;
}

// Eliminar ticket
function eliminarTicket(ticketId) {
    if (confirm('¿Está seguro de que desea eliminar este ticket?')) {
        fetch('/tickets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=delete&ticket_id=' + ticketId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Eliminar la fila de la tabla
                document.getElementById('ticket-row-' + ticketId).remove();
                alert('Ticket eliminado exitosamente');
            } else {
                alert('Error al eliminar ticket: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar ticket');
        });
    }
}

// Cargar municipios para el filtro cuando se selecciona un departamento
function cargarMunicipiosFiltro() {
    const departamentoId = document.getElementById('filtro_departamento').value;
    const municipioSelect = document.getElementById('filtro_municipio');
    
    // Limpiar municipios
    municipioSelect.innerHTML = '<option value="">Todos los municipios</option>';
    
    if (departamentoId) {
        municipioSelect.disabled = false;
        
        fetch(`/api/municipios/${departamentoId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    data.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.id;
                        option.textContent = municipio.nombre;
                        municipioSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error cargando municipios:', error);
            });
    } else {
        municipioSelect.disabled = true;
    }
}

// Filtrar tickets del lado cliente
function filtrarTickets() {
    const filtroDepartamento = document.getElementById('filtro_departamento').value;
    const filtroMunicipio = document.getElementById('filtro_municipio').value;
    const filtroTipologia = document.getElementById('filtro_tipologia').value;
    const filtroFecha = document.getElementById('filtro_fecha').value;
    
    const filas = document.querySelectorAll('#ticketsTable tbody tr');
    
    filas.forEach(fila => {
        let mostrar = true;
        
        // Filtrar por departamento
        if (filtroDepartamento) {
            const celdaDepartamento = fila.cells[2]; // Columna de departamento
            const departamentoTicket = celdaDepartamento.getAttribute('data-departamento-id');
            if (departamentoTicket !== filtroDepartamento) {
                mostrar = false;
            }
        }
        
        // Filtrar por municipio
        if (filtroMunicipio) {
            const celdaMunicipio = fila.cells[3]; // Columna de municipio
            const municipioTicket = celdaMunicipio.getAttribute('data-municipio-id');
            if (municipioTicket !== filtroMunicipio) {
                mostrar = false;
            }
        }
        
        // Filtrar por tipología
        if (filtroTipologia) {
            const celdaTipologia = fila.cells[4]; // Columna de tipología
            const tipologiaTicket = celdaTipologia.getAttribute('data-tipologia-id');
            if (tipologiaTicket !== filtroTipologia) {
                mostrar = false;
            }
        }
        
        // Filtrar por fecha
        if (filtroFecha) {
            const celdaFecha = fila.cells[1]; // Columna de fecha
            const fechaTicket = celdaFecha.textContent.trim();
            if (fechaTicket !== filtroFecha) {
                mostrar = false;
            }
        }
        
        fila.style.display = mostrar ? '' : 'none';
    });
}

function limpiarFiltros() {
    document.getElementById('filtro_departamento').value = '';
    document.getElementById('filtro_municipio').value = '';
    document.getElementById('filtro_municipio').disabled = true;
    document.getElementById('filtro_municipio').innerHTML = '<option value="">Todos los municipios</option>';
    document.getElementById('filtro_tipologia').value = '';
    document.getElementById('filtro_fecha').value = '';
    filtrarTickets();
}
</script>
{% endblock %}