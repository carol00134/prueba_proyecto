{% extends "base.html" %}

{% block title %}Gestión de Catálogos - Sistema{% endblock %}

{% block page_title %}Gestión de Catálogos{% endblock %}

{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}
<style>
.catalog-container {
  background: #fff;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  margin-bottom: 2rem;
}

.nav-tabs .nav-link {
  color: #6b7280;
  border: none;
  border-bottom: 3px solid transparent;
  font-weight: 600;
  padding: 1rem 1.5rem;
}

.nav-tabs .nav-link.active {
  color: #6366f1;
  border-bottom-color: #6366f1;
  background: none;
}

.form-inline {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
  margin-bottom: 2rem;
}

.form-group {
  flex: 0 0 350px;
}

.form-group label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
  display: block;
}

.form-control {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
}

.form-control:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.btn-primary {
  background: linear-gradient(90deg, #6366f1 0%, #4338ca 100%);
  border: none;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  font-size: 0.875rem;
}

.btn-secondary {
  background: #6b7280;
  border: none;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-warning {
  background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
  border: none;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-danger {
  background: linear-gradient(90deg, #dc2626 0%, #b91c1c 100%);
  border: none;
  color: white;
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.btn:hover {
  transform: translateY(-1px);
}

.table-container {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.table {
  margin-bottom: 0;
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: #374151;
  border: none;
  padding: 1rem;
}

.table td {
  padding: 1rem;
  border-color: #f1f5f9;
  vertical-align: middle;
}

.required {
  color: #dc2626;
}
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">
        <i class="fas fa-database me-2"></i>Gestión de Catálogos
      </h1>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
  {% endif %}

  <!-- Pestañas de navegación -->
  <ul class="nav nav-tabs" id="catalogTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="departamentos-tab" data-bs-toggle="tab" data-bs-target="#departamentos" type="button" role="tab">
        <i class="fas fa-map me-2"></i>Departamentos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="municipios-tab" data-bs-toggle="tab" data-bs-target="#municipios" type="button" role="tab">
        <i class="fas fa-city me-2"></i>Municipios
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tipologias-tab" data-bs-toggle="tab" data-bs-target="#tipologias" type="button" role="tab">
        <i class="fas fa-tags me-2"></i>Tipologías
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="despachos-tab" data-bs-toggle="tab" data-bs-target="#despachos" type="button" role="tab">
        <i class="fas fa-building me-2"></i>Despachos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="unidades-tab" data-bs-toggle="tab" data-bs-target="#unidades" type="button" role="tab">
        <i class="fas fa-truck me-2"></i>Unidades
      </button>
    </li>
  </ul>

  <!-- Contenido de las pestañas -->
  <div class="tab-content" id="catalogTabsContent">
    
    <!-- Departamentos -->
    <div class="tab-pane fade show active" id="departamentos" role="tabpanel">
      <div class="catalog-container">
        <h3 class="mb-3">Departamentos</h3>
        <form method="POST" action="{{ url_for('catalogos') }}">
          <input type="hidden" name="tabla" value="departamentos">
          <div class="form-inline">
            <div class="form-group">
              <label for="nombre_depto" style="font-size: 0.875rem;">Departamento <span class="required">*</span></label>
              <input type="text" id="nombre_depto" name="nombre" class="form-control" style="padding: 0.5rem; height: 40px; font-size: 0.875rem;" required>
            </div>
            <button type="submit" name="accion" value="agregar" class="btn btn-primary" style="width: auto; display: inline-block; padding: 0.5rem 1.2rem; height: 40px; font-size: 0.875rem;">
              <i class="fas fa-plus me-2"></i>Agregar
            </button>
          </div>
        </form>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Municipios</th>
                <th style="text-align: center;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for depto in departamentos %}
              <tr id="depto-row-{{ depto.id }}">
                <td>{{ depto.id }}</td>
                <td>
                  <span class="view-mode" id="depto-name-{{ depto.id }}">{{ depto.nombre }}</span>
                  <input type="text" class="form-control edit-mode" id="depto-input-{{ depto.id }}" 
                         value="{{ depto.nombre }}" style="display: none;">
                </td>
                <td>{{ depto.municipios_count or 0 }} municipios</td>
                <td style="text-align: center;">
                  <div class="btn-group" role="group">
                    <button class="btn btn-warning btn-sm" onclick="editDepartamento('{{ depto.id }}')" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm edit-mode" id="save-depto-{{ depto.id }}" 
                            onclick="saveDepartamento('{{ depto.id }}')" style="display: none; width: auto; padding: 0.375rem 0.75rem;">
                      <i class="fas fa-save"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm edit-mode" id="cancel-depto-{{ depto.id }}" 
                            onclick="cancelEditDepartamento('{{ depto.id }}')" style="display: none; width: auto; padding: 0.375rem 0.75rem;">
                      <i class="fas fa-times"></i>
                    </button>
                    <form style="display: inline;" method="POST" action="{{ url_for('catalogos') }}" 
                          onsubmit="return confirm('¿Está seguro de eliminar este departamento?')">
                      <input type="hidden" name="tabla" value="departamentos">
                      <input type="hidden" name="id" value="{{ depto.id }}">
                      <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm" style="width: auto; display: inline-block; padding: 0.375rem 0.75rem;">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Municipios -->
    <div class="tab-pane fade" id="municipios" role="tabpanel">
      <div class="catalog-container">
        <h3 class="mb-3">Municipios</h3>
        <form method="POST" action="{{ url_for('catalogos') }}">
          <input type="hidden" name="tabla" value="municipios">
          <div class="form-inline">
            <div class="form-group">
              <label for="departamento_id">Departamento <span class="required">*</span></label>
              <select id="departamento_id" name="departamento_id" class="form-control" required>
                <option value="">Seleccione un departamento</option>
                {% for depto in departamentos %}
                <option value="{{ depto.id }}">{{ depto.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="nombre_muni">Nombre del Municipio <span class="required">*</span></label>
              <input type="text" id="nombre_muni" name="nombre" class="form-control" required>
            </div>
            <button type="submit" name="accion" value="agregar" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Agregar
            </button>
          </div>
        </form>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Municipio</th>
                <th>Departamento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for muni in municipios %}
              <tr id="muni-row-{{ muni.id }}">
                <td>{{ muni.id }}</td>
                <td>
                  <span class="view-mode" id="muni-name-{{ muni.id }}">{{ muni.nombre }}</span>
                  <input type="text" class="form-control edit-mode" id="muni-input-{{ muni.id }}" 
                         value="{{ muni.nombre }}" style="display: none;">
                </td>
                <td>{{ muni.departamento_nombre }}</td>
                <td>
                  <div class="btn-group" role="group">
                    <button class="btn btn-warning btn-sm" onclick="editMunicipio('{{ muni.id }}')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm edit-mode" id="save-muni-{{ muni.id }}" 
                            onclick="saveMunicipio('{{ muni.id }}')" style="display: none;">
                      <i class="fas fa-save"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm edit-mode" id="cancel-muni-{{ muni.id }}" 
                            onclick="cancelEditMunicipio('{{ muni.id }}')" style="display: none;">
                      <i class="fas fa-times"></i>
                    </button>
                    <form style="display: inline;" method="POST" action="{{ url_for('catalogos') }}" 
                          onsubmit="return confirm('¿Está seguro de eliminar este municipio?')">
                      <input type="hidden" name="tabla" value="municipios">
                      <input type="hidden" name="id" value="{{ muni.id }}">
                      <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tipologías -->
    <div class="tab-pane fade" id="tipologias" role="tabpanel">
      <div class="catalog-container">
        <h3 class="mb-3">Tipologías y Subtipologías</h3>
        <form method="POST" action="{{ url_for('catalogos') }}">
          <input type="hidden" name="tabla" value="tipologias">
          <div class="form-inline">
            <div class="form-group">
              <label for="nombre_tipo">Nombre de la Tipología <span class="required">*</span></label>
              <input type="text" id="nombre_tipo" name="nombre" class="form-control" required>
            </div>
            <button type="submit" name="accion" value="agregar" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Agregar
            </button>
          </div>
        </form>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Tipología</th>
                <th>Subtipologías</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for tipo in tipologias %}
              <tr>
                <td>{{ tipo.id }}</td>
                <td>{{ tipo.nombre }}</td>
                <td>{{ tipo.subtipologias_count or 0 }} subtipologías</td>
                <td>
                  <form style="display: inline;" method="POST" action="{{ url_for('catalogos') }}" 
                        onsubmit="return confirm('¿Está seguro de eliminar esta tipología?')">
                    <input type="hidden" name="tabla" value="tipologias">
                    <input type="hidden" name="id" value="{{ tipo.id }}">
                    <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Despachos -->
    <div class="tab-pane fade" id="despachos" role="tabpanel">
      <div class="catalog-container">
        <h3 class="mb-3">Despachos</h3>
        <form method="POST" action="{{ url_for('catalogos') }}">
          <input type="hidden" name="tabla" value="despachos">
          <div class="form-inline">
            <div class="form-group">
              <label for="nombre_despacho">Nombre del Despacho <span class="required">*</span></label>
              <input type="text" id="nombre_despacho" name="nombre" class="form-control" required>
            </div>
            <button type="submit" name="accion" value="agregar" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Agregar
            </button>
          </div>
        </form>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for despacho in despachos %}
              <tr>
                <td>{{ despacho.id }}</td>
                <td>{{ despacho.nombre }}</td>
                <td>
                  <form style="display: inline;" method="POST" action="{{ url_for('catalogos') }}" 
                        onsubmit="return confirm('¿Está seguro de eliminar este despacho?')">
                    <input type="hidden" name="tabla" value="despachos">
                    <input type="hidden" name="id" value="{{ despacho.id }}">
                    <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Unidades -->
    <div class="tab-pane fade" id="unidades" role="tabpanel">
      <div class="catalog-container">
        <h3 class="mb-3">Unidades Movilizadas</h3>
        <form method="POST" action="{{ url_for('catalogos') }}">
          <input type="hidden" name="tabla" value="unidades">
          <div class="form-inline">
            <div class="form-group">
              <label for="nombre_unidad">Nombre de la Unidad <span class="required">*</span></label>
              <input type="text" id="nombre_unidad" name="nombre" class="form-control" required>
            </div>
            <button type="submit" name="accion" value="agregar" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Agregar
            </button>
          </div>
        </form>
        
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for unidad in unidades %}
              <tr>
                <td>{{ unidad.id }}</td>
                <td>{{ unidad.nombre }}</td>
                <td>
                  <form style="display: inline;" method="POST" action="{{ url_for('catalogos') }}" 
                        onsubmit="return confirm('¿Está seguro de eliminar esta unidad?')">
                    <input type="hidden" name="tabla" value="unidades">
                    <input type="hidden" name="id" value="{{ unidad.id }}">
                    <button type="submit" name="accion" value="eliminar" class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// Funciones para editar departamentos
function editDepartamento(id) {
  document.getElementById('depto-name-' + id).style.display = 'none';
  document.getElementById('depto-input-' + id).style.display = 'block';
  document.getElementById('save-depto-' + id).style.display = 'inline-block';
  document.getElementById('cancel-depto-' + id).style.display = 'inline-block';
}

function cancelEditDepartamento(id) {
  document.getElementById('depto-name-' + id).style.display = 'block';
  document.getElementById('depto-input-' + id).style.display = 'none';
  document.getElementById('save-depto-' + id).style.display = 'none';
  document.getElementById('cancel-depto-' + id).style.display = 'none';
  // Restaurar valor original
  const originalValue = document.getElementById('depto-name-' + id).textContent;
  document.getElementById('depto-input-' + id).value = originalValue;
}

function saveDepartamento(id) {
  const nuevoNombre = document.getElementById('depto-input-' + id).value.trim();
  if (!nuevoNombre) {
    alert('El nombre no puede estar vacío');
    return;
  }
  
  // Crear form oculto para enviar datos
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/catalogos';
  
  const tablaInput = document.createElement('input');
  tablaInput.type = 'hidden';
  tablaInput.name = 'tabla';
  tablaInput.value = 'departamentos';
  
  const accionInput = document.createElement('input');
  accionInput.type = 'hidden';
  accionInput.name = 'accion';
  accionInput.value = 'editar';
  
  const idInput = document.createElement('input');
  idInput.type = 'hidden';
  idInput.name = 'id';
  idInput.value = id;
  
  const nombreInput = document.createElement('input');
  nombreInput.type = 'hidden';
  nombreInput.name = 'nombre';
  nombreInput.value = nuevoNombre;
  
  form.appendChild(tablaInput);
  form.appendChild(accionInput);
  form.appendChild(idInput);
  form.appendChild(nombreInput);
  
  document.body.appendChild(form);
  form.submit();
}

// Funciones similares para otros catálogos...
function editMunicipio(id) {
  document.getElementById('muni-name-' + id).style.display = 'none';
  document.getElementById('muni-input-' + id).style.display = 'block';
  document.getElementById('save-muni-' + id).style.display = 'inline-block';
  document.getElementById('cancel-muni-' + id).style.display = 'inline-block';
}

function cancelEditMunicipio(id) {
  document.getElementById('muni-name-' + id).style.display = 'block';
  document.getElementById('muni-input-' + id).style.display = 'none';
  document.getElementById('save-muni-' + id).style.display = 'none';
  document.getElementById('cancel-muni-' + id).style.display = 'none';
  const originalValue = document.getElementById('muni-name-' + id).textContent;
  document.getElementById('muni-input-' + id).value = originalValue;
}

function saveMunicipio(id) {
  const nuevoNombre = document.getElementById('muni-input-' + id).value.trim();
  if (!nuevoNombre) {
    alert('El nombre no puede estar vacío');
    return;
  }
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/catalogos';
  
  form.innerHTML = `
    <input type="hidden" name="tabla" value="municipios">
    <input type="hidden" name="accion" value="editar">
    <input type="hidden" name="id" value="${id}">
    <input type="hidden" name="nombre" value="${nuevoNombre}">
  `;
  
  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}