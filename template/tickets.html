{% extends "base.html" %}

{% block title %}Gestión de Tickets - Sistema{% endblock %}

{% block page_title %}<i class="fas fa-ticket-alt me-2"></i>Gestión de Tickets{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='tickets.css') }}">

<div class="container-fluid">

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
  {% endif %}

  <!-- Formulario de ticket -->
  <div class="ticket-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 id="form-title">Crear Nuevo Ticket</h5>
      <button type="button" class="btn btn-secondary btn-sm" onclick="limpiarFormulario()">
        <i class="fas fa-plus me-2"></i>Nuevo Ticket
      </button>
    </div>
    
    <form method="POST" action="{{ url_for('tickets_routes.tickets') }}" id="ticketForm">
      <input type="hidden" id="ticket_id" name="ticket_id" value="0">
      
      <div class="form-container">
        <h6 class="mb-3">Información Básica</h6>
        
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="fecha" class="form-label">Fecha y Hora <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="fecha" name="fecha" required>
          </div>
          <div class="col-md-4">
            <label for="regional" class="form-label">Regional</label>
            <input type="text" class="form-control" id="regional" name="regional" placeholder="Ej: Norte, Sur, Centro">
          </div>
          <div class="col-md-4">
            <label for="id_usuario" class="form-label">Usuario <span class="text-danger">*</span></label>
            <select class="form-select" id="id_usuario" name="id_usuario" required>
              <option value="">Seleccione un usuario</option>
              {% for usuario in usuarios %}
              <option value="{{ usuario.id }}">{{ usuario.nombre }} ({{ usuario.usuario }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Ubicación</h6>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_departamento" class="form-label">Departamento <span class="text-danger">*</span></label>
            <select class="form-select" id="id_departamento" name="id_departamento" required>
              <option value="">Seleccione un departamento</option>
              {% for depto in departamentos %}
              <option value="{{ depto.id }}">{{ depto.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="id_municipio" class="form-label">Municipio <span class="text-danger">*</span></label>
            <select class="form-select" id="id_municipio" name="id_municipio" required>
              <option value="">Seleccione un municipio</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="latitud" class="form-label">Latitud</label>
            <input type="number" class="form-control" id="latitud" name="latitud" step="any" placeholder="4.6097100">
          </div>
          <div class="col-md-6">
            <label for="longitud" class="form-label">Longitud</label>
            <input type="number" class="form-control" id="longitud" name="longitud" step="any" placeholder="-74.0817500">
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Clasificación</h6>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_tipologia" class="form-label d-block mb-2">Tipología <span class="text-danger">*</span></label>
            <select class="form-select" id="id_tipologia" name="id_tipologia" required>
              <option value="">Seleccione una tipología</option>
              {% for tipo in tipologias %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="id_subtipologia" class="form-label d-block mb-2">Subtipología</label>
            <select class="form-select" id="id_subtipologia" name="id_subtipologia">
              <option value="">Seleccione una subtipología</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Detalles</h6>
        
        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripción</label>
          <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="nota_respaldo" class="form-label">Nota de Respaldo</label>
            <textarea class="form-control" id="nota_respaldo" name="nota_respaldo" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label for="id_mando" class="form-label">Mando</label>
            <input type="text" class="form-control" id="id_mando" name="id_mando" placeholder="Nombre del mando">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="registro" class="form-label">Registro</label>
            <textarea class="form-control" id="registro" name="registro" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label for="nota_final" class="form-label">Nota Final</label>
            <textarea class="form-control" id="nota_final" name="nota_final" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Asignaciones</h6>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label">Despachos</label>
            <div class="checkbox-group">
              {% for despacho in despachos %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="despacho_{{ despacho.id }}" name="despachos" value="{{ despacho.id }}">
                <label class="form-check-label" for="despacho_{{ despacho.id }}">
                  {{ despacho.nombre }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label">Unidades</label>
            <div class="checkbox-group">
              {% for unidad in unidades %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="unidad_{{ unidad.id }}" name="unidades" value="{{ unidad.id }}">
                <label class="form-check-label" for="unidad_{{ unidad.id }}">
                  {{ unidad.nombre }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary btn-sm btn-create-ticket me-2" id="submit-btn">
          <i class="fas fa-save me-1"></i>Crear
        </button>
        <button type="button" class="btn btn-secondary btn-sm btn-cancel-ticket" onclick="limpiarFormulario()">
          <i class="fas fa-times me-1"></i>Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de tickets -->
  <div class="ticket-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Lista de Tickets</h5>
      <a href="/agregar_ticket" class="btn btn-primary btn-sm">
        <i class="fas fa-plus me-1"></i>Agregar Ticket
      </a>
    </div>

<!--cargar rchivo excel-->
<br>


    
    <!-- Filtros -->
    <div class="row mb-3">
      <div class="col-md-2">
        <select class="form-select" id="filtro_departamento" onchange="filtrarTickets()">
          <option value="">Departamentos</option>
          {% for depto in departamentos %}
          <option value="{{ depto.id }}">{{ depto.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" id="filtro_tipologia" onchange="cargarSubtipologiasFiltro(); filtrarTickets()">
          <option value="">Tipologías</option>
          {% for tipo in tipologias %}
          <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" id="filtro_subtipologia" onchange="filtrarTickets()">
          <option value="">Subtipologías</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" id="filtro_fecha" onchange="filtrarTickets()">
      </div>
      <div class="col-md-4">
        <button class="btn btn-secondary btn-sm" onclick="limpiarFiltros()">
          <i class="fas fa-refresh"></i> Limpiar
        </button>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-responsive">
        <table class="table" id="ticketsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Regional</th>
              <th>Departamento</th>
              <th>Municipio</th>
              <th>Tipología</th>
              <th>Subtipología</th>
              <th>Coordenadas</th>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
            <tr id="ticket-row-{{ ticket.id }}">
              <td><strong>#{{ ticket.id }}</strong></td>
              <td>{{ ticket.fecha_hora.strftime('%d/%m/%Y %H:%M') if ticket.fecha_hora else 'N/A' }}</td>
              <td>{{ ticket.regional or 'N/A' }}</td>
              <td>{{ ticket.departamento_nombre }}</td>
              <td>{{ ticket.municipio_nombre }}</td>
              <td>{{ ticket.tipologia_nombre }}</td>
              <td>{{ ticket.subtipologia_nombre or 'N/A' }}</td>
              <td class="coordinates">
                {% if ticket.latitud and ticket.longitud %}
                  {{ "%.6f"|format(ticket.latitud) }},<br>{{ "%.6f"|format(ticket.longitud) }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>{{ ticket.usuario_nombre or 'N/A' }}</td>
              <td>{{ ticket.usuario_rol or 'N/A' }}</td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-warning btn-sm" onclick="editarTicket('{{ ticket.id }}')" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="eliminarTicket('{{ ticket.id }}')" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {% if not tickets %}
      <div class="text-center p-4">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">No hay tickets registrados.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Cargar municipios según departamento
document.getElementById('id_departamento').addEventListener('change', function() {
    const departamentoId = this.value;
    const municipioSelect = document.getElementById('id_municipio');
    
    console.log('Departamento seleccionado:', departamentoId);
    municipioSelect.innerHTML = '<option value="">Cargando municipios...</option>';
    
    if (departamentoId) {
        fetch(`/api/municipios/${departamentoId}`)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Municipios recibidos:', data);
                municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
                
                if (data && data.length > 0) {
                    data.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.id;
                        option.textContent = municipio.nombre;
                        municipioSelect.appendChild(option);
                    });
                } else {
                    municipioSelect.innerHTML = '<option value="">No hay municipios disponibles</option>';
                }
            })
            .catch(error => {
                console.error('Error completo al cargar municipios:', error);
                municipioSelect.innerHTML = '<option value="">Error al cargar municipios</option>';
            });
    } else {
        municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
    }
});

// Cargar subtipologías según tipología
document.getElementById('id_tipologia').addEventListener('change', function() {
    const tipologiaId = this.value;
    const subtipologiaSelect = document.getElementById('id_subtipologia');
    
    subtipologiaSelect.innerHTML = '<option value="">Seleccione una subtipología</option>';
    
    if (tipologiaId) {
        fetch(`/api/subtipologias/${tipologiaId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subtipologia => {
                    const option = document.createElement('option');
                    option.value = subtipologia.id;
                    option.textContent = subtipologia.nombre;
                    subtipologiaSelect.appendChild(option);
                });
            });
    }
});

// Editar ticket
function editarTicket(ticketId) {
    fetch(`/api/ticket/${ticketId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ticket = data.ticket_data;
                
                // Actualizar título y botón
                document.getElementById('form-title').textContent = `Editar Ticket #${ticketId}`;
                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save me-1"></i>Actualizar';
                
                // Llenar formulario
                document.getElementById('ticket_id').value = ticketId;
                if (ticket.fecha) document.getElementById('fecha').value = ticket.fecha;
                if (ticket.id_usuario) document.getElementById('id_usuario').value = ticket.id_usuario;
                if (ticket.id_departamento) document.getElementById('id_departamento').value = ticket.id_departamento;
                if (ticket.id_tipologia) document.getElementById('id_tipologia').value = ticket.id_tipologia;
                if (ticket.latitud) document.getElementById('latitud').value = ticket.latitud;
                if (ticket.longitud) document.getElementById('longitud').value = ticket.longitud;
                if (ticket.descripcion) document.getElementById('descripcion').value = ticket.descripcion;
                if (ticket.nota_respaldo) document.getElementById('nota_respaldo').value = ticket.nota_respaldo;
                if (ticket.id_mando) document.getElementById('id_mando').value = ticket.id_mando;
                if (ticket.registro) document.getElementById('registro').value = ticket.registro;
                if (ticket.nota_final) document.getElementById('nota_final').value = ticket.nota_final;
                
                // Cargar municipios y subtipologías
                if (ticket.id_departamento) {
                    fetch(`/api/municipios/${ticket.id_departamento}`)
                        .then(response => response.json())
                        .then(municipios => {
                            const municipioSelect = document.getElementById('id_municipio');
                            municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
                            municipios.forEach(municipio => {
                                const option = document.createElement('option');
                                option.value = municipio.id;
                                option.textContent = municipio.nombre;
                                if (municipio.id == ticket.id_municipio) option.selected = true;
                                municipioSelect.appendChild(option);
                            });
                        });
                }
                
                if (ticket.id_tipologia) {
                    fetch(`/api/subtipologias/${ticket.id_tipologia}`)
                        .then(response => response.json())
                        .then(subtipologias => {
                            const subtipologiaSelect = document.getElementById('id_subtipologia');
                            subtipologiaSelect.innerHTML = '<option value="">Seleccione una subtipología</option>';
                            subtipologias.forEach(subtipologia => {
                                const option = document.createElement('option');
                                option.value = subtipologia.id;
                                option.textContent = subtipologia.nombre;
                                if (subtipologia.id == ticket.id_subtipologia) option.selected = true;
                                subtipologiaSelect.appendChild(option);
                            });
                        });
                }
                
                // Resaltar fila
                document.querySelectorAll('tr').forEach(row => row.classList.remove('edit-row'));
                document.getElementById(`ticket-row-${ticketId}`).classList.add('edit-row');
                
                // Scroll al formulario
                document.querySelector('.ticket-container').scrollIntoView({ behavior: 'smooth' });
            }
        });
}

// Eliminar ticket
function eliminarTicket(ticketId) {
    if (confirm('¿Está seguro de eliminar este ticket?')) {
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('ticket_id', ticketId);
        
        fetch('/tickets', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar el ticket');
            }
        });
    }
}

// Mostrar formulario para agregar ticket
function mostrarFormulario() {
    // Limpiar el formulario
    limpiarFormulario();
    
    // Hacer scroll hasta el formulario
    document.querySelector('.form-container').scrollIntoView({
        behavior: 'smooth'
    });
    
    // Enfocar el primer campo
    document.getElementById('fecha').focus();
}

// Limpiar formulario
function limpiarFormulario() {
    document.getElementById('ticketForm').reset();
    document.getElementById('ticket_id').value = '0';
    document.getElementById('form-title').textContent = 'Crear Nuevo Ticket';
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save me-1"></i>Crear';
    document.querySelectorAll('tr').forEach(row => row.classList.remove('edit-row'));
    document.getElementById('id_municipio').innerHTML = '<option value="">Seleccione un municipio</option>';
    document.getElementById('id_subtipologia').innerHTML = '<option value="">Seleccione una subtipología</option>';
}

// Cargar subtipologías para filtro
function cargarSubtipologiasFiltro() {
    const tipologiaId = document.getElementById('filtro_tipologia').value;
    const subtipologiaSelect = document.getElementById('filtro_subtipologia');
    
    subtipologiaSelect.innerHTML = '<option value="">Todas las subtipologías</option>';
    
    if (tipologiaId) {
        fetch(`/api/subtipologias/${tipologiaId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subtipologia => {
                    const option = document.createElement('option');
                    option.value = subtipologia.id;
                    option.textContent = subtipologia.nombre;
                    subtipologiaSelect.appendChild(option);
                });
            });
    }
}

// Filtrar tickets (función básica)
function filtrarTickets() {
    const filtroDepartamento = document.getElementById('filtro_departamento').value;
    const filtroTipologia = document.getElementById('filtro_tipologia').value;
    const filtroSubtipologia = document.getElementById('filtro_subtipologia').value;
    const filtroFecha = document.getElementById('filtro_fecha').value;
    
    const rows = document.querySelectorAll('#ticketsTable tbody tr');
    
    rows.forEach(row => {
        let mostrar = true;
        
        // Filtro por departamento (ahora es columna 3)
        if (filtroDepartamento) {
            const departamento = row.cells[3].textContent.trim();
            const departamentoSelect = document.getElementById('filtro_departamento');
            const selectedOption = departamentoSelect.options[departamentoSelect.selectedIndex];
            if (selectedOption && departamento !== selectedOption.textContent) {
                mostrar = false;
            }
        }
        
        // Filtro por tipología (ahora es columna 5)
        if (filtroTipologia) {
            const tipologia = row.cells[5].textContent.trim();
            const tipologiaSelect = document.getElementById('filtro_tipologia');
            const selectedOption = tipologiaSelect.options[tipologiaSelect.selectedIndex];
            if (selectedOption && tipologia !== selectedOption.textContent) {
                mostrar = false;
            }
        }
        
        // Filtro por subtipología (ahora es columna 6)
        if (filtroSubtipologia) {
            const subtipologia = row.cells[6].textContent.trim();
            const subtipologiaSelect = document.getElementById('filtro_subtipologia');
            const selectedOption = subtipologiaSelect.options[subtipologiaSelect.selectedIndex];
            if (selectedOption && subtipologia !== selectedOption.textContent && subtipologia !== 'N/A') {
                mostrar = false;
            }
        }
        
        // Filtro por fecha (sigue siendo columna 1)
        if (filtroFecha) {
            const fechaTicket = row.cells[1].textContent.trim();
            if (fechaTicket !== 'N/A') {
                const fechaTicketFormateada = fechaTicket.split(' ')[0].split('/').reverse().join('-');
                if (fechaTicketFormateada !== filtroFecha) {
                    mostrar = false;
                }
            }
        }
        
        row.style.display = mostrar ? '' : 'none';
    });
}

function limpiarFiltros() {
    document.getElementById('filtro_departamento').value = '';
    document.getElementById('filtro_tipologia').value = '';
    document.getElementById('filtro_subtipologia').value = '';
    document.getElementById('filtro_fecha').value = '';
    cargarSubtipologiasFiltro(); // Limpiar subtipologías
    filtrarTickets();
}
</script>
{% endblock %}