{% extends "base.html" %}

{% block title %}Gesti칩n de Tickets - Sistema{% endblock %}

{% block page_title %}<i class="fas fa-ticket-alt me-2"></i>Gesti칩n de Tickets{% endblock %}

{% block back_button %}
<a href="/" class="btn-back">
  <i class="fas fa-home me-1"></i>Inicio
</a>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='tickets.css') }}">

<style>
.page-navigation h6 {
    color: #374151;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
}
</style>

<div class="container-fluid">

  {% if error %}
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
  {% endif %}

  {% if success %}
  <div class="alert alert-success" role="alert">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
  {% endif %}

  <!-- Formulario de ticket - Solo si puede crear -->
  {% if can_perform_action('tickets', 'crear') %}
  <div class="ticket-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 id="form-title">Crear Nuevo Ticket</h5>
      <button type="button" class="btn btn-secondary btn-sm" onclick="limpiarFormulario()">
        <i class="fas fa-plus me-2"></i>Nuevo Ticket
      </button>
    </div>
    
    <form method="POST" action="{{ url_for('tickets_routes.tickets') }}" id="ticketForm">
      <input type="hidden" id="ticket_id" name="ticket_id" value="0">
      
      <div class="form-container">
        <h6 class="mb-3">Informaci칩n B치sica</h6>
        
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="fecha" class="form-label">Fecha y Hora <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="fecha" name="fecha" required>
          </div>
          <div class="col-md-4">
            <label for="regional" class="form-label">Regional</label>
            <input type="text" class="form-control" id="regional" name="regional" placeholder="Ej: Norte, Sur, Centro">
          </div>
          <div class="col-md-4">
            <label for="id_usuario" class="form-label">Usuario <span class="text-danger">*</span></label>
            <select class="form-select" id="id_usuario" name="id_usuario" required>
              <option value="">Seleccione un usuario</option>
              {% for usuario in usuarios %}
              <option value="{{ usuario.id }}">{{ usuario.nombre }} ({{ usuario.usuario }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Ubicaci칩n</h6>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_departamento" class="form-label">Departamento <span class="text-danger">*</span></label>
            <select class="form-select" id="id_departamento" name="id_departamento" required>
              <option value="">Seleccione un departamento</option>
              {% for depto in departamentos %}
              <option value="{{ depto.id }}">{{ depto.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="id_municipio" class="form-label">Municipio <span class="text-danger">*</span></label>
            <select class="form-select" id="id_municipio" name="id_municipio" required>
              <option value="">Seleccione un municipio</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="latitud" class="form-label">Latitud</label>
            <input type="number" class="form-control" id="latitud" name="latitud" step="any" placeholder="4.6097100">
          </div>
          <div class="col-md-6">
            <label for="longitud" class="form-label">Longitud</label>
            <input type="number" class="form-control" id="longitud" name="longitud" step="any" placeholder="-74.0817500">
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Clasificaci칩n</h6>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_tipologia" class="form-label d-block mb-2">Tipolog칤a <span class="text-danger">*</span></label>
            <select class="form-select" id="id_tipologia" name="id_tipologia" required>
              <option value="">Seleccione una tipolog칤a</option>
              {% for tipo in tipologias %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="id_subtipologia" class="form-label d-block mb-2">Subtipolog칤a</label>
            <select class="form-select" id="id_subtipologia" name="id_subtipologia">
              <option value="">Seleccione una subtipolog칤a</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Detalles</h6>
        
        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripci칩n</label>
          <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="nota_respaldo" class="form-label">Nota de Respaldo</label>
            <textarea class="form-control" id="nota_respaldo" name="nota_respaldo" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label for="id_mando" class="form-label">Mando</label>
            <input type="text" class="form-control" id="id_mando" name="id_mando" placeholder="Nombre del mando">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="registro" class="form-label">Registro</label>
            <textarea class="form-control" id="registro" name="registro" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label for="nota_final" class="form-label">Nota Final</label>
            <textarea class="form-control" id="nota_final" name="nota_final" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="form-container">
        <h6 class="mb-3">Asignaciones</h6>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label">Despachos</label>
            <div class="checkbox-group">
              {% for despacho in despachos %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="despacho_{{ despacho.id }}" name="despachos" value="{{ despacho.id }}">
                <label class="form-check-label" for="despacho_{{ despacho.id }}">
                  {{ despacho.nombre }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label">Unidades</label>
            <div class="checkbox-group">
              {% for unidad in unidades %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="unidad_{{ unidad.id }}" name="unidades" value="{{ unidad.id }}">
                <label class="form-check-label" for="unidad_{{ unidad.id }}">
                  {{ unidad.nombre }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="text-center ticket-buttons-container">
        <button type="submit" id="submit-btn" class="tiny-btn tiny-btn-primary" title="Crear ticket">+</button>
        <button type="button" id="cancel-btn" class="tiny-btn tiny-btn-secondary" onclick="limpiarFormulario()" title="Cancelar">칑</button>
      </div>
    </form>
  </div>
  {% endif %}

  <!-- Lista de tickets -->
  <div class="table-container">
    <h3 class="p-3 mb-0 border-bottom">
      <i class="fas fa-list me-2"></i>Lista de Tickets
    </h3>
    
    <!-- Filtros -->
    <div class="p-3">
      <div class="row mb-3">
        <div class="col-md-2">
          <select class="form-select" id="filtro_departamento" onchange="cargarMunicipiosFiltro(); filtrarTickets()">
            <option value="">Departamentos</option>
            {% for depto in departamentos %}
            <option value="{{ depto.id }}">{{ depto.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filtro_municipio" onchange="filtrarTickets()">
            <option value="">Municipios</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filtro_tipologia" onchange="cargarSubtipologiasFiltro(); filtrarTickets()">
            <option value="">Tipolog칤as</option>
            {% for tipo in tipologias %}
            <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filtro_subtipologia" onchange="filtrarTickets()">
            <option value="">Subtipolog칤as</option>
          </select>
        </div>
        <div class="col-md-2">
          <input type="date" class="form-control" id="filtro_fecha" onchange="filtrarTickets()">
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary btn-sm" onclick="limpiarFiltros()">
            <i class="fas fa-refresh"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table" id="ticketsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Regional</th>
              <th>Departamento</th>
              <th>Municipio</th>
              <th>Tipolog칤a</th>
              <th>Subtipolog칤a</th>
              <th>Coordenadas</th>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
            <tr id="ticket-row-{{ ticket.id }}">
              <td><strong>#{{ ticket.id }}</strong></td>
              <td>{{ ticket.fecha_hora.strftime('%d/%m/%Y %H:%M') if ticket.fecha_hora else 'N/A' }}</td>
              <td>{{ ticket.regional or 'N/A' }}</td>
              <td>{{ ticket.departamento_nombre }}</td>
              <td>{{ ticket.municipio_nombre }}</td>
              <td>{{ ticket.tipologia_nombre }}</td>
              <td>{{ ticket.subtipologia_nombre or 'N/A' }}</td>
              <td class="coordinates">
                {% if ticket.latitud and ticket.longitud %}
                  {{ "%.6f"|format(ticket.latitud) }},<br>{{ "%.6f"|format(ticket.longitud) }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>{{ ticket.usuario_nombre or 'N/A' }}</td>
              <td>{{ ticket.usuario_rol or 'N/A' }}</td>
              <td>
                <div class="btn-group" role="group">
                  {% if can_perform_action('tickets', 'editar') %}
                  <button class="btn btn-outline-warning btn-sm" onclick="editarTicket('{{ ticket.id }}')" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  {% endif %}
                  {% if can_perform_action('tickets', 'eliminar') %}
                  <button class="btn btn-outline-danger btn-sm" onclick="eliminarTicket('{{ ticket.id }}')" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {% if not tickets %}
      <div class="text-center p-4">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">No hay tickets registrados.</p>
      </div>
      {% endif %}
  </div>
</div>

<script>
// Cargar municipios seg칰n departamento
document.getElementById('id_departamento').addEventListener('change', function() {
    const departamentoId = this.value;
    const municipioSelect = document.getElementById('id_municipio');
    
    console.log('Departamento seleccionado:', departamentoId);
    municipioSelect.innerHTML = '<option value="">Cargando municipios...</option>';
    
    if (departamentoId) {
        fetch(`/api/municipios/${departamentoId}`)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Municipios recibidos:', data);
                municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
                
                if (data && data.length > 0) {
                    data.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.id;
                        option.textContent = municipio.nombre;
                        municipioSelect.appendChild(option);
                    });
                } else {
                    municipioSelect.innerHTML = '<option value="">No hay municipios disponibles</option>';
                }
            })
            .catch(error => {
                console.error('Error completo al cargar municipios:', error);
                municipioSelect.innerHTML = '<option value="">Error al cargar municipios</option>';
            });
    } else {
        municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
    }
});

// Cargar subtipolog칤as seg칰n tipolog칤a
document.getElementById('id_tipologia').addEventListener('change', function() {
    const tipologiaId = this.value;
    const subtipologiaSelect = document.getElementById('id_subtipologia');
    
    subtipologiaSelect.innerHTML = '<option value="">Seleccione una subtipolog칤a</option>';
    
    if (tipologiaId) {
        fetch(`/api/subtipologias/${tipologiaId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subtipologia => {
                    const option = document.createElement('option');
                    option.value = subtipologia.id;
                    option.textContent = subtipologia.nombre;
                    subtipologiaSelect.appendChild(option);
                });
            });
    }
});

// Editar ticket
function editarTicket(ticketId) {
    fetch(`/api/ticket/${ticketId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ticket = data.ticket_data;
                
                console.log('Datos completos del ticket:', data);
                console.log('Ticket data:', ticket);
                console.log('Despachos:', ticket.despachos);
                console.log('Unidades:', ticket.unidades);
                
                // Actualizar t칤tulo y bot칩n
                document.getElementById('form-title').textContent = `Editar Ticket #${ticketId}`;
                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save"></i>';
                document.getElementById('submit-btn').title = 'Actualizar ticket';
                
                // Llenar formulario
                document.getElementById('ticket_id').value = ticketId;
                if (ticket.fecha) document.getElementById('fecha').value = ticket.fecha;
                if (ticket.regional) document.getElementById('regional').value = ticket.regional;
                if (ticket.id_usuario) document.getElementById('id_usuario').value = ticket.id_usuario;
                if (ticket.id_departamento) document.getElementById('id_departamento').value = ticket.id_departamento;
                if (ticket.id_tipologia) document.getElementById('id_tipologia').value = ticket.id_tipologia;
                if (ticket.latitud) document.getElementById('latitud').value = ticket.latitud;
                if (ticket.longitud) document.getElementById('longitud').value = ticket.longitud;
                if (ticket.descripcion) document.getElementById('descripcion').value = ticket.descripcion;
                if (ticket.nota_respaldo) document.getElementById('nota_respaldo').value = ticket.nota_respaldo;
                if (ticket.id_mando) document.getElementById('id_mando').value = ticket.id_mando;
                if (ticket.registro) document.getElementById('registro').value = ticket.registro;
                if (ticket.nota_final) document.getElementById('nota_final').value = ticket.nota_final;
                
                // Cargar municipios y subtipolog칤as
                if (ticket.id_departamento) {
                    fetch(`/api/municipios/${ticket.id_departamento}`)
                        .then(response => response.json())
                        .then(municipios => {
                            const municipioSelect = document.getElementById('id_municipio');
                            municipioSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
                            municipios.forEach(municipio => {
                                const option = document.createElement('option');
                                option.value = municipio.id;
                                option.textContent = municipio.nombre;
                                if (municipio.id == ticket.id_municipio) option.selected = true;
                                municipioSelect.appendChild(option);
                            });
                        });
                }
                
                if (ticket.id_tipologia) {
                    fetch(`/api/subtipologias/${ticket.id_tipologia}`)
                        .then(response => response.json())
                        .then(subtipologias => {
                            const subtipologiaSelect = document.getElementById('id_subtipologia');
                            subtipologiaSelect.innerHTML = '<option value="">Seleccione una subtipolog칤a</option>';
                            subtipologias.forEach(subtipologia => {
                                const option = document.createElement('option');
                                option.value = subtipologia.id;
                                option.textContent = subtipologia.nombre;
                                if (subtipologia.id == ticket.id_subtipologia) option.selected = true;
                                subtipologiaSelect.appendChild(option);
                            });
                        });
                }
                
                // Cargar y marcar checkboxes de despachos
                console.log('Procesando despachos...');
                const despachosCheckboxes = document.querySelectorAll('input[name="despachos"]');
                console.log('Checkboxes de despachos disponibles:', despachosCheckboxes.length);
                despachosCheckboxes.forEach((cb, index) => {
                    console.log(`Checkbox ${index}:`, cb.id, cb.value);
                });
                
                if (ticket.despachos && ticket.despachos.length > 0) {
                    console.log('Despachos encontrados:', ticket.despachos);
                    // Limpiar todos los checkboxes de despachos primero
                    despachosCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Marcar los checkboxes seleccionados
                    ticket.despachos.forEach(despachoId => {
                        console.log('Buscando checkbox para despacho:', despachoId);
                        const checkbox = document.getElementById(`despacho_${despachoId}`);
                        console.log('Checkbox encontrado:', checkbox);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log('Checkbox marcado para despacho:', despachoId);
                        }
                    });
                } else {
                    console.log('No hay despachos asignados o datos vac칤os');
                }
                
                // Cargar y marcar checkboxes de unidades
                console.log('Procesando unidades...');
                const unidadesCheckboxes = document.querySelectorAll('input[name="unidades"]');
                console.log('Checkboxes de unidades disponibles:', unidadesCheckboxes.length);
                unidadesCheckboxes.forEach((cb, index) => {
                    console.log(`Checkbox ${index}:`, cb.id, cb.value);
                });
                
                if (ticket.unidades && ticket.unidades.length > 0) {
                    console.log('Unidades encontradas:', ticket.unidades);
                    // Limpiar todos los checkboxes de unidades primero
                    unidadesCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Marcar los checkboxes seleccionados
                    ticket.unidades.forEach(unidadId => {
                        console.log('Buscando checkbox para unidad:', unidadId);
                        const checkbox = document.getElementById(`unidad_${unidadId}`);
                        console.log('Checkbox encontrado:', checkbox);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log('Checkbox marcado para unidad:', unidadId);
                        }
                    });
                } else {
                    console.log('No hay unidades asignadas o datos vac칤os');
                }
                
                // Resaltar fila
                document.querySelectorAll('tr').forEach(row => row.classList.remove('edit-row'));
                document.getElementById(`ticket-row-${ticketId}`).classList.add('edit-row');
                
                // Scroll al formulario
                document.querySelector('.ticket-container').scrollIntoView({ behavior: 'smooth' });
            }
        });
}

// Eliminar ticket
function eliminarTicket(ticketId) {
    if (confirm('쮼st치 seguro de eliminar este ticket?')) {
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('ticket_id', ticketId);
        
        fetch('/tickets', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar el ticket');
            }
        });
    }
}

// Mostrar formulario para agregar ticket
function mostrarFormulario() {
    // Limpiar el formulario
    limpiarFormulario();
    
    // Hacer scroll hasta el formulario
    document.querySelector('.form-container').scrollIntoView({
        behavior: 'smooth'
    });
    
    // Enfocar el primer campo
    document.getElementById('fecha').focus();
}

// Limpiar formulario
function limpiarFormulario() {
    document.getElementById('ticketForm').reset();
    document.getElementById('ticket_id').value = '0';
    document.getElementById('form-title').textContent = 'Crear Nuevo Ticket';
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-plus"></i>';
    document.getElementById('submit-btn').title = 'Crear ticket';
    document.querySelectorAll('tr').forEach(row => row.classList.remove('edit-row'));
    document.getElementById('id_municipio').innerHTML = '<option value="">Seleccione un municipio</option>';
    document.getElementById('id_subtipologia').innerHTML = '<option value="">Seleccione una subtipolog칤a</option>';
}

// Cargar municipios para filtro
function cargarMunicipiosFiltro() {
    const departamentoId = document.getElementById('filtro_departamento').value;
    const municipioSelect = document.getElementById('filtro_municipio');
    
    municipioSelect.innerHTML = '<option value="">Municipios</option>';
    
    if (departamentoId) {
        fetch(`/api/municipios/${departamentoId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.textContent = municipio.nombre;
                    municipioSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar municipios para filtro:', error);
            });
    }
}

// Cargar subtipolog칤as para filtro
function cargarSubtipologiasFiltro() {
    const tipologiaId = document.getElementById('filtro_tipologia').value;
    const subtipologiaSelect = document.getElementById('filtro_subtipologia');
    
    subtipologiaSelect.innerHTML = '<option value="">Subtipolog칤as</option>';
    
    if (tipologiaId) {
        fetch(`/api/subtipologias/${tipologiaId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subtipologia => {
                    const option = document.createElement('option');
                    option.value = subtipologia.id;
                    option.textContent = subtipologia.nombre;
                    subtipologiaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar subtipolog칤as para filtro:', error);
            });
    }
}

// Filtrar tickets - VERSI칍N SIMPLIFICADA PARA DEBUG
function filtrarTickets() {
    console.log('=== INICIANDO FILTRADO ===');
    
    // Verificar que existan los elementos
    const filtroDepartamento = document.getElementById('filtro_departamento');
    const filtroMunicipio = document.getElementById('filtro_municipio');
    const tabla = document.getElementById('ticketsTable');
    
    if (!filtroDepartamento) {
        console.error(' No se encuentra el elemento filtro_departamento');
        return;
    }
    
    if (!tabla) {
        console.error(' No se encuentra la tabla ticketsTable');
        return;
    }
    
    const rows = tabla.querySelectorAll('tbody tr');
    console.log(` Encontradas ${rows.length} filas en la tabla`);
    
    if (rows.length === 0) {
        console.log(' No hay tickets en la tabla para filtrar');
        return;
    }
    
    // Obtener valores de filtros
    const valorDepartamento = filtroDepartamento.value;
    const valorMunicipio = filtroMunicipio ? filtroMunicipio.value : '';
    
    console.log(`游댌 Filtros aplicados:`, {
        departamento: valorDepartamento,
        municipio: valorMunicipio
    });
    
    // Si no hay filtros activos, mostrar todo
    if (!valorDepartamento && !valorMunicipio) {
        console.log('游늶 No hay filtros activos, mostrando todos los tickets');
        rows.forEach(row => {
            row.style.display = '';
        });
        return;
    }
    
    let ticketsMostrados = 0;
    let ticketsOcultos = 0;
    
    rows.forEach((row, index) => {
        let mostrar = true;
        const cells = row.cells;
        
        if (!cells || cells.length < 5) {
            console.log(`丘멆잺 Fila ${index} no tiene suficientes celdas`);
            return;
        }
        
        const ticketId = cells[0].textContent.trim();
        console.log(`\n游꿞 Procesando ticket: ${ticketId}`);
        
        // Filtro por departamento
        if (valorDepartamento) {
            const departamentoEnTabla = cells[3].textContent.trim();
            const optionSeleccionada = filtroDepartamento.options[filtroDepartamento.selectedIndex];
            const departamentoFiltro = optionSeleccionada ? optionSeleccionada.textContent.trim() : '';
            
            console.log(`    Departamento tabla: "${departamentoEnTabla}"`);
            console.log(`    Departamento filtro: "${departamentoFiltro}"`);
            
            if (departamentoEnTabla !== departamentoFiltro) {
                mostrar = false;
                console.log(`    No coincide departamento`);
            } else {
                console.log(`    Coincide departamento`);
            }
        }
        
        // Filtro por municipio
        if (valorMunicipio && mostrar && filtroMunicipio) {
            const municipioEnTabla = cells[4].textContent.trim();
            const optionSeleccionada = filtroMunicipio.options[filtroMunicipio.selectedIndex];
            const municipioFiltro = optionSeleccionada ? optionSeleccionada.textContent.trim() : '';
            
            console.log(`    Municipio tabla: "${municipioEnTabla}"`);
            console.log(`    Municipio filtro: "${municipioFiltro}"`);
            
            if (municipioEnTabla !== municipioFiltro) {
                mostrar = false;
                console.log(`    No coincide municipio`);
            } else {
                console.log(`    Coincide municipio`);
            }
        }
        
        // Aplicar visibilidad
        row.style.display = mostrar ? '' : 'none';
        
        if (mostrar) {
            ticketsMostrados++;
            console.log(`    MOSTRAR ticket ${ticketId}`);
        } else {
            ticketsOcultos++;
            console.log(`    OCULTAR ticket ${ticketId}`);
        }
    });
    
    console.log(`\n RESULTADO: ${ticketsMostrados} mostrados, ${ticketsOcultos} ocultos`);
    console.log('=== FILTRADO COMPLETADO ===\n');
}

function limpiarFiltros() {
    document.getElementById('filtro_departamento').value = '';
    document.getElementById('filtro_municipio').innerHTML = '<option value="">Municipios</option>';
    document.getElementById('filtro_municipio').value = '';
    document.getElementById('filtro_tipologia').value = '';
    document.getElementById('filtro_subtipologia').innerHTML = '<option value="">Subtipolog칤as</option>';
    document.getElementById('filtro_subtipologia').value = '';
    document.getElementById('filtro_fecha').value = '';
    filtrarTickets(); // Mostrar todos los tickets
}

// FORZAR TAMA칌O DE BOTONES CON JAVASCRIPT - VERSI칍N MEJORADA
document.addEventListener('DOMContentLoaded', function() {
    console.log('游 P치gina de tickets cargada');
    
    // Verificar elementos cr칤ticos
    const elementos = [
        'filtro_departamento',
        'filtro_municipio', 
        'ticketsTable'
    ];
    
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            console.log(` Elemento ${id} encontrado`);
        } else {
            console.error(` Elemento ${id} NO encontrado`);
        }
    });
    
    // Verificar si hay tickets en la tabla
    const tabla = document.getElementById('ticketsTable');
    if (tabla) {
        const filas = tabla.querySelectorAll('tbody tr');
        console.log(` Tickets en tabla: ${filas.length}`);
        
        if (filas.length > 0) {
            console.log(' Ejemplo de ticket en fila 0:');
            const primeraFila = filas[0];
            for (let i = 0; i < primeraFila.cells.length; i++) {
                console.log(`   Columna ${i}: "${primeraFila.cells[i].textContent.trim()}"`);
            }
        }
    }
    
    function forzarTama침oBotones() {
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        
        const estilosComunes = {
            width: '20px',
            height: '18px',
            minWidth: '20px',
            maxWidth: '20px',
            minHeight: '18px',
            maxHeight: '18px',
            padding: '0',
            margin: '0 1px',
            fontSize: '10px',
            fontWeight: 'bold',
            lineHeight: '1',
            borderWidth: '1px',
            borderStyle: 'solid',
            borderRadius: '3px',
            color: 'white',
            textAlign: 'center',
            display: 'inline-block',
            boxSizing: 'border-box',
            cursor: 'pointer',
            outline: 'none',
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            verticalAlign: 'top',
            fontFamily: 'Arial, sans-serif'
        };
        
        if (submitBtn) {
            Object.assign(submitBtn.style, estilosComunes);
            submitBtn.style.borderColor = '#007bff';
            submitBtn.style.backgroundColor = '#007bff';
            submitBtn.style.background = '#007bff';
        }
        
        if (cancelBtn) {
            Object.assign(cancelBtn.style, estilosComunes);
            cancelBtn.style.borderColor = '#6c757d';
            cancelBtn.style.backgroundColor = '#6c757d';
            cancelBtn.style.background = '#6c757d';
        }
    }
    
    // Aplicar m칰ltiples veces para asegurar que funcione
    forzarTama침oBotones();
    setTimeout(forzarTama침oBotones, 50);
    setTimeout(forzarTama침oBotones, 200);
    setTimeout(forzarTama침oBotones, 500);
    setTimeout(forzarTama침oBotones, 1000);
    
    // Tambi칠n aplicar cuando hay cambios en el DOM
    const observer = new MutationObserver(forzarTama침oBotones);
    observer.observe(document.body, { childList: true, subtree: true });
});
</script>
{% endblock %}