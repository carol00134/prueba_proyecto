<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Actividades</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bitacora.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-history"></i> Bitácora de Actividades</h1>
            <div class="header-actions">
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Inicio
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <form method="GET" class="filters-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="fecha_inicio">Fecha Inicio:</label>
                        <input type="date" id="fecha_inicio" name="fecha_inicio" 
                               value="{{ filters.fecha_inicio }}">
                    </div>
                    
                    <div class="filter-group">
                        <label for="fecha_fin">Fecha Fin:</label>
                        <input type="date" id="fecha_fin" name="fecha_fin" 
                               value="{{ filters.fecha_fin }}">
                    </div>
                    
                    <div class="filter-group">
                        <label for="usuario">Usuario:</label>
                        <select id="usuario" name="usuario">
                            <option value="">Todos los usuarios</option>
                            {% for usuario in usuarios %}
                            <option value="{{ usuario }}" 
                                    {% if filters.usuario == usuario %}selected{% endif %}>
                                {{ usuario }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="modulo">Módulo:</label>
                        <select id="modulo" name="modulo">
                            <option value="">Todos los módulos</option>
                            {% for modulo in modulos %}
                            <option value="{{ modulo }}" 
                                    {% if filters.modulo == modulo %}selected{% endif %}>
                                {{ modulo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="accion">Acción:</label>
                        <select id="accion" name="accion">
                            <option value="">Todas las acciones</option>
                            {% for accion in acciones %}
                            <option value="{{ accion }}" 
                                    {% if filters.accion == accion %}selected{% endif %}>
                                {{ accion }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <a href="/bitacora" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Información de registros -->
        <div class="info-section">
            <p class="record-count">
                Mostrando {{ registros|length }} de {{ total_records }} registros
                {% if total_pages > 1 %}
                (Página {{ current_page }} de {{ total_pages }})
                {% endif %}
            </p>
        </div>

        <!-- Tabla de registros -->
        <div class="table-container">
            <table class="bitacora-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha/Hora</th>
                        <th>Usuario</th>
                        <th>Acción</th>
                        <th>Módulo</th>
                        <th>Descripción</th>
                        <th>IP</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in registros %}
                    <tr>
                        <td>{{ registro.id }}</td>
                        <td class="fecha-col">{{ registro.fecha_hora.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                        <td class="usuario-col">{{ registro.usuario_nombre }}</td>
                        <td>
                            <span class="accion-badge accion-{{ registro.accion.lower() }}">
                                {{ registro.accion }}
                            </span>
                        </td>
                        <td class="modulo-col">{{ registro.modulo }}</td>
                        <td class="descripcion-col">
                            {% if registro.descripcion %}
                                {{ registro.descripcion[:100] }}{% if registro.descripcion|length > 100 %}...{% endif %}
                            {% else %}
                                <em>Sin descripción</em>
                            {% endif %}
                        </td>
                        <td class="ip-col">{{ registro.ip_address or 'N/A' }}</td>
                        <td class="actions-col">
                            <button onclick="verDetalle({{ registro.id }})" 
                                    class="btn btn-small btn-info" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not registros %}
            <div class="no-data">
                <i class="fas fa-inbox"></i>
                <p>No se encontraron registros con los filtros aplicados.</p>
            </div>
            {% endif %}
        </div>

        <!-- Paginación -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if current_page > 1 %}
                <a href="?{{ request.query_string.decode() | replace('page=' + current_page|string, 'page=' + (current_page-1)|string) }}" 
                   class="btn btn-pagination">
                    <i class="fas fa-chevron-left"></i> Anterior
                </a>
            {% endif %}
            
            <span class="pagination-info">
                Página {{ current_page }} de {{ total_pages }}
            </span>
            
            {% if current_page < total_pages %}
                <a href="?{{ request.query_string.decode() | replace('page=' + current_page|string, 'page=' + (current_page+1)|string) }}" 
                   class="btn btn-pagination">
                    Siguiente <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Modal para detalles -->
    <div id="detalleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Detalle del Registro</h3>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            <div class="modal-body" id="detalleContent">
                <!-- El contenido se carga dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        function verDetalle(id) {
            fetch(`/bitacora/detalle/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    let content = `
                        <div class="detalle-grid">
                            <div class="detalle-item">
                                <strong>ID:</strong> ${data.id}
                            </div>
                            <div class="detalle-item">
                                <strong>Usuario:</strong> ${data.usuario_nombre}
                            </div>
                            <div class="detalle-item">
                                <strong>Fecha/Hora:</strong> ${data.fecha_hora}
                            </div>
                            <div class="detalle-item">
                                <strong>Acción:</strong> 
                                <span class="accion-badge accion-${data.accion.toLowerCase()}">${data.accion}</span>
                            </div>
                            <div class="detalle-item">
                                <strong>Módulo:</strong> ${data.modulo}
                            </div>
                            <div class="detalle-item">
                                <strong>IP:</strong> ${data.ip_address || 'N/A'}
                            </div>
                            <div class="detalle-item full-width">
                                <strong>Descripción:</strong><br>
                                ${data.descripcion || 'Sin descripción'}
                            </div>
                            <div class="detalle-item full-width">
                                <strong>User Agent:</strong><br>
                                <small>${data.user_agent || 'N/A'}</small>
                            </div>
                    `;
                    
                    if (data.datos_anteriores) {
                        content += `
                            <div class="detalle-item full-width">
                                <strong>Datos Anteriores:</strong>
                                <pre>${JSON.stringify(data.datos_anteriores, null, 2)}</pre>
                            </div>
                        `;
                    }
                    
                    if (data.datos_nuevos) {
                        content += `
                            <div class="detalle-item full-width">
                                <strong>Datos Nuevos:</strong>
                                <pre>${JSON.stringify(data.datos_nuevos, null, 2)}</pre>
                            </div>
                        `;
                    }
                    
                    content += '</div>';
                    
                    document.getElementById('detalleContent').innerHTML = content;
                    document.getElementById('detalleModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar los detalles');
                });
        }

        function cerrarModal() {
            document.getElementById('detalleModal').style.display = 'none';
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const detalleModal = document.getElementById('detalleModal');
            
            if (event.target == detalleModal) {
                detalleModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>